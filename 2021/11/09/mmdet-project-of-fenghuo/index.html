<!DOCTYPE HTML>
<html lang="default">
    



<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="mmdet &amp;&amp; project of fenghuo, Dian.AI CV ADV NLP DeepLearning MachineLearning é€¯æ¶¦é›¨ Lurunyu CV,NLP,ADV æ·±åº¦å­¦ä¹ ">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="KeoTn_OFy4ndJwXNmm2gMeQfPhd7alqE9vQDwI32KCY">
    <meta name="description" content="
é¡¹ç›®GitHubä»“åº“åœ°å€ï¼šhttps://github.com/LRY89757/mmdet-for-fenghuo

Preface
2021.11.9æ—¥æ›´æ–°ï¼š

æœ¬åšå®¢è®°å½•çƒ½ç«é¡¹ç›®æœ¬äººçš„åšé¡¹ç›®çš„æŠ€æœ¯è¿‡ç¨‹ã€‚é¦–å…ˆâ€”â€”æˆ‘ä¸ä¼šåˆ†å‰²å‘¢è¿˜ğŸ˜£ğŸ˜£">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mmdet &amp;&amp; project of fenghuo | LRY&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/lightgallery/1.6.12/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <style type="text/css">
        
            
            code[class*="language-"],
            pre[class*="language-"] {
                white-space: pre !important;
            }

        
    </style>

    <script src="https://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://dian.org.cn/static/dian/images/logo.dd99a9865177.gif" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">LRY's Blog</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>Index</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>Tags</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>Categories</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>Archives</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/galleries" class="waves-effect waves-light">
            
            <i class="fa fa-photo"></i>
            
            <span>Galleries</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>About</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-envelope"></i>
            
            <span>Contact</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>Friends</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="Search"></i>
        </a>
    </li>
</ul> -->

<!-- æ”¯æŒäºŒçº§èœå•ç‰¹æ€§   -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/" class="waves-effect waves-light">
              
                <i class="fa fa-home"></i>
              
              <span>Index</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/tags" class="waves-effect waves-light">
              
                <i class="fa fa-tags"></i>
              
              <span>Tags</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories" class="waves-effect waves-light">
              
                <i class="fa fa-bookmark"></i>
              
              <span>Categories</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/archives" class="waves-effect waves-light">
              
                <i class="fa fa-archive"></i>
              
              <span>Archives</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/galleries" class="waves-effect waves-light">
              
                <i class="fa fa-photo"></i>
              
              <span>Galleries</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/about" class="waves-effect waves-light">
              
                <i class="fa fa-user-circle-o"></i>
              
              <span>About</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i class="fa fa-envelope"></i>
              
              <span>Contact</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/friends" class="waves-effect waves-light">
              
                <i class="fa fa-address-book"></i>
              
              <span>Friends</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="Search"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://dian.org.cn/static/dian/images/logo.dd99a9865177.gif" class="logo-img circle responsive-img">
        
        <div class="logo-name">LRY's Blog</div>
        <div class="logo-desc">
            
            åä¸­ç§‘æŠ€å¤§å­¦ | è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ | æ·±åº¦å­¦ä¹ 
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                Index
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                Tags
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                Categories
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                Archives
            </a>
        </li>
        
        <li>
            <a href="/galleries" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-photo"></i>
                
                Galleries
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                About
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-envelope"></i>
                
                Contact
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                Friends
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/LRY89757" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

   
   
<!-- æ”¯æŒäºŒçº§èœå•ç‰¹æ€§   -->
<!-- <ul class="menu-list mobile-menu-list">
    
        <li class="m-nav-item">
                
                    <a href="/" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-home"></i>
                        
                        Index
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/tags" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-tags"></i>
                        
                        Tags
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/categories" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-bookmark"></i>
                        
                        Categories
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/archives" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-archive"></i>
                        
                        Archives
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/galleries" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-photo"></i>
                        
                        Galleries
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/about" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-user-circle-o"></i>
                        
                        About
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/contact" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-envelope"></i>
                        
                        Contact
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/friends" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-address-book"></i>
                        
                        Friends
                    </a>
              
            </li>
        

        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/LRY89757" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul> -->

</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/LRY89757" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        mmdet &amp;&amp; project of fenghuo
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        
<!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/æ·±åº¦å­¦ä¹ /" target="_blank">
                                <span class="chip bg-color">æ·±åº¦å­¦ä¹ </span>
                            </a>
                        
                            <a href="/tags/çƒ½ç«é›†å›¢/" target="_blank">
                                <span class="chip bg-color">çƒ½ç«é›†å›¢</span>
                            </a>
                        
                            <a href="/tags/é¡¹ç›®/" target="_blank">
                                <span class="chip bg-color">é¡¹ç›®</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/æ·±åº¦å­¦ä¹ /" class="post-category" target="_blank">
                                æ·±åº¦å­¦ä¹ 
                            </a>
                        
                    </div>
                    
                </div>
            </div>
            
            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-11-09
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>Author:&nbsp;&nbsp;
                    
                        é€¯æ¶¦é›¨
                    
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>Words:&nbsp;&nbsp;
                        14.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>Read Times:&nbsp;&nbsp;
                        65 Min
                    </div>
                    
                
                
                
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        <i class="fa fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv" ></span>
    
                

            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>é¡¹ç›®GitHubä»“åº“åœ°å€ï¼š<a href="https://github.com/LRY89757/mmdet-for-fenghuo" target="_blank" rel="noopener">https://github.com/LRY89757/mmdet-for-fenghuo</a></p>
</blockquote>
<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><blockquote>
<p>2021.11.9æ—¥æ›´æ–°ï¼š</p>
</blockquote>
<p>æœ¬åšå®¢è®°å½•çƒ½ç«é¡¹ç›®æœ¬äººçš„åšé¡¹ç›®çš„æŠ€æœ¯è¿‡ç¨‹ã€‚é¦–å…ˆâ€”â€”æˆ‘ä¸ä¼šåˆ†å‰²å‘¢è¿˜ğŸ˜£ğŸ˜£ğŸ˜£ï¼Œæˆ‘å°±å¤§æ¦‚çŸ¥é“åˆ†å‰²æ˜¯ä»€ä¹ˆå¦å¤–å°±æ˜¯æ•°æ®é›†å¤§è‡´å½¢å¼â€¦â€¦ï¼ˆ<del>è™½ç„¶ç›®å‰æ¥çœ‹ä¹Ÿå¤Ÿäº†â€¦â€¦</del>ï¼‰</p>
<p>è¿™å°±æ˜¯â€å¹²ä¸­å­¦â€å˜›ğŸ˜­ğŸ˜­ã€‚</p>
<p>å¹¸äºçš„æ˜¯ï¼Œä¹‹å‰çœ‹çš„è®¸å¤šå®˜æ–¹æ–‡æ¡£æˆ‘éƒ½è®°å½•äº†ç›¸å…³çš„è¿‡ç¨‹ï¼Œä¸éœ€è¦é‡å¤çœ‹æ–‡æ¡£äº†ï¼Œè€Œä¸”ã€‚ä¸€ä¸ªæ›´å¥½çš„æ¶ˆæ¯å°±æ˜¯æˆ‘å½“æ—¶çœ‹çš„å®˜æ–¹æ–‡æ¡£å‡ ä¹éƒ½æ˜¯å…³äºMaskRCNNçš„ï¼Œæˆ‘å®é™…ä¸Šå¯¹è¿™äº›ä¸œè¥¿çš„æµ‹è¯•è®­ç»ƒçš„å¾ˆå¤šæµç¨‹éå¸¸æ¸…æ¥šäº†ï¼ˆ<del>åªæ˜¯ä¸€éƒ¨åˆ†ï¼Œä¸€å°éƒ¨åˆ†</del>ï¼‰ï¼Œè¿™å°±ä¸ºæˆ‘è™½ç„¶ä¸ç†Ÿæ‚‰ã€ä¸å¤ªä¼šMaskRCNNä½†æ˜¯ä¸ä¼šå¯¹æˆ‘è®­ç»ƒã€å¯¹æˆ‘æ¨ç†ç›¸å…³æ¨¡å‹äº§ç”Ÿä¸€äº›å¾ˆå¤§çš„éšœç¢ï¼Œæˆ‘æˆ–è®¸åªéœ€è¦å°±æƒ³åœ¨åšæ£€æµ‹ä¸€æ ·æ¥åšè¿™ä¸€ä»¶äº‹å°±å¥½äº†ã€‚å½“ç„¶è¾“å…¥å’Œè¾“å‡ºè¿˜æ˜¯è¦æˆ‘è‡ªå·±æ¥æå®šçš„ï¼Œè¿™ä¹Ÿæ˜¯æœ€ä¸å¥½å¼„çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>ç”±äºæœ¬æœˆæœˆæœ«ä¼šæœ‰ä¸¤åœºæ¯”è¾ƒé‡è¦çš„è€ƒè¯•ï¼Œæ‰€ä»¥æœ€å¥½æˆ‘èƒ½åœ¨æœ¬å‘¨å¤§è‡´å†™å‡ºä¸€éƒ¨åˆ†ä»£ç ç„¶ådebugä¸€äº›ä¸œè¥¿ï¼Œè¿™ä¸¤å‘¨å¯ä»¥é€‚å½“å¤šå‚åŠ ä¸€ä¸‹é¡¹ç›®ç„¶ååˆ°æœ¬æœˆåä¸€å‘¨å¼€å§‹å‡†å¤‡è€ƒè¯•ã€‚</p>
<h1 id="2021-11-9æ—¥æ™šæ›´æ–°"><a href="#2021-11-9æ—¥æ™šæ›´æ–°" class="headerlink" title="2021.11.9æ—¥æ™šæ›´æ–°"></a>2021.11.9æ—¥æ™šæ›´æ–°</h1><p>å·®ä¸å¤šç¡®å®šè®¡åˆ’ä¹‹åï¼Œè¿™ä¸€æ™šä¸Šè¿˜æ˜¯å…ˆçœ‹çœ‹æˆ‘ä¹‹å‰çš„æ‰€æœ‰å…³äºMMDetectionçš„åšå®¢ï¼Œå¯¹äºè®­ç»ƒå’Œæµ‹è¯•ä»¥åŠæ•°æ®é›†é‡æ–°ç†Ÿæ‚‰æ•´åˆä¸€ä¸‹ã€‚</p>
<p><strong>Note</strong>: MMDetection only supports evaluating mask AP of dataset in COCO format for now. So for instance segmentation task users should convert the data into coco format.</p>
<h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><h3 id="dataset-prepare"><a href="#dataset-prepare" class="headerlink" title="dataset prepare"></a>dataset prepare</h3><p>è¿™é‡Œæˆ‘åˆæ­¥æ‰“ç®—æ ¹æ®æˆ‘ä»¬çš„jsonæ–‡ä»¶å†™ä¸€ä¸ªè½¬åŒ–ä¸ºCOCOæ•°æ®é›†çš„<code>.py</code>æ–‡ä»¶ï¼Œå› ä¸ºç»„é•¿æ¨èçš„å†™ä¸€ä¸ªdataloaderè¿™ç§æ–¹å¼æˆ‘ç›®å‰æ²¡æœ‰å¤ªæ˜ç™½ï¼Œåæ­£ä¸ç®¡é»‘çŒ«ç™½çŒ«,å…ˆå†™å‡ºæ¥èƒ½è·‘å°±è¡ŒğŸ˜ã€‚</p>
<p>COCOæ•°æ®é›†å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">{</span>
    <span class="token string">"images"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"annotations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>annotation<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"categories"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>category<span class="token punctuation">]</span>
<span class="token punctuation">}</span>


image <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"width"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"height"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"file_name"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

annotation <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"image_id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"category_id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"segmentation"</span><span class="token punctuation">:</span> RLE <span class="token operator">or</span> <span class="token punctuation">[</span>polygon<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"area"</span><span class="token punctuation">:</span> float<span class="token punctuation">,</span>
    <span class="token string">"bbox"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>width<span class="token punctuation">,</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"iscrowd"</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token operator">or</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
    <span class="token string">"supercategory"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“æ—¶çœ‹å®˜ç½‘åå†™çš„åšå®¢å½“æ—¶ç¬¬ä¸€æ­¥å°±æ˜¯è½¬åŒ–ä¸€ä¸‹æ•°æ®é›†ï¼Œå½“æ—¶å®˜ç½‘ä¸“é—¨æä¾›äº†ä¸€ä¸ªBallonæ•°æ®é›†ï¼Œä¹Ÿæ˜¯äºŒåˆ†ç±»çš„æ•°æ®é›†ï¼Œå½“æ—¶æ•°æ®é›†çš„æ ¼å¼ç¡®å®ä¸æ˜¯éå¸¸åˆç†çœ‹ç€ï¼Œåé˜¿é‡Œç»è¿‡è½¬åŒ–ä¹‹åå˜æˆäº†COCOçš„æ ‡å‡†æ ¼å¼ï¼Œæˆ‘ä»¬è¿™é‡Œé‡æ–°æ¥çœ‹ä¸€ä¸‹,å¸å–ä¸Šæ¬¡çš„æ•™è®­ï¼Œè¿™é‡Œé€‰æ‹©åˆ†å±‚æ¥çœ‹ç»“æ„ï¼š</p>
<ul>
<li>ç¬¬ä¸€å±‚ç»“æ„ï¼š<br><a href="https://imagelol.com/image/I967LC" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/11/09/I967LC.png" alt></a><br>å¤§ç»“æ„å°±æ˜¯å›¾åƒéƒ½æœ‰ä»€ä¹ˆï¼Œç„¶åæ ‡è®°éƒ½æ˜¯ä»€ä¹ˆï¼Œç„¶åæ˜¯åˆ†ç±»çš„ç±»åˆ«éƒ½æœ‰ä»€ä¹ˆ.æ¥ä¸‹æ¥æ·±å…¥çœ‹ï¼š</li>
<li>ç¬¬äºŒå±‚ç»“æ„ä¹‹<code>images</code><br><a href="https://imagelol.com/image/I96d4R" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/11/09/I96d4R.png" alt></a></li>
</ul>
<p><code>images</code>ä¸»è¦è®°å½•çš„å°±æ˜¯å›¾ç‰‡çš„ä¸€ä¸ªidsè¿˜æœ‰é«˜å®½ï¼Œè¿™ä¸ªé«˜å®½è¿˜æ˜¯è›®é‡è¦çš„ï¼Œä»¥åŠæ–‡ä»¶åã€‚</p>
<ul>
<li><p>ç¬¬äºŒå±‚ç»“æ„ä¹‹<code>annotations</code><br><a href="https://imagelol.com/image/I96eDz" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/11/09/I96eDz.png" alt></a><br>è¯¥å±‚å°±æ˜¯æˆ‘ä»¬çš„åˆ†ç±»category_idå’Œæ¡†bboxè¿˜æœ‰åˆ†å‰²æ•°æ®segmentationçš„ç»“æ„äº†ã€‚category_idæ˜¯ç±»åˆ«çš„ç§ç±»æ•°ï¼Œbboxæ˜¯æ£€æµ‹æ¡†ï¼Œsegmentationæ˜¯åˆ†å‰²çš„æ•°æ®æ ‡æ³¨ã€‚å…¶ä»–çš„æ˜¯å’Œä¸Šé¢çš„ä¸€ä¸€å¯¹åº”çš„ï¼ˆ<del>æ¯”å¦‚è¯´image_idè¡¨ç¤ºè¯¥æ ‡æ³¨å±äºé‚£ä¸€å¼ å›¾ç‰‡â€¦â€¦</del>ï¼‰ï¼Œè¿˜æœ‰ä¸€äº›ä¸è¯´äº†ï¼Œä¸æ˜¯éå¸¸é‡è¦ã€‚<br>çœ‹ä¸‹å®Œæ•´çš„åŒ…å«å…·ä½“bboxå’Œsegmentationæ•°æ®çš„å›¾ï¼š<br><a href="https://imagelol.com/image/I96U2p" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/11/09/I96U2p.png" alt></a></p>
</li>
<li><p>ç¬¬äºŒå±‚ç»“æ„ä¹‹<code>categories</code>:<br><a href="https://imagelol.com/image/I96Y9W" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/11/09/I96Y9W.png" alt></a></p>
</li>
</ul>
<p>ç”±äºè¿™ä¸ªæ•°æ®é›†éå¸¸ç®€å•,å°±æ˜¯ä¸€ä¸ªå…³äºballoonçš„æ£€æµ‹åˆ†å‰²ä»»åŠ¡,æ‰€ä»¥ç±»åˆ«åªæœ‰ä¸€ä¸ª,ç›¸å¯¹è€Œè¨€è¿˜æŒºå¥½.<br><del>æˆ‘çªç„¶èœœæ±è‡ªä¿¡,æˆ‘ä»¬çš„æ•°æ®ä¹Ÿæ˜¯åˆæ­¥åªæœ‰ä¸€ä¸ªæ¡†è®©æˆ‘ä»¬æ£€æµ‹,æˆ‘æ€ä¹ˆè§‰å¾—æˆ‘åˆè¡Œäº†</del></p>
<p>å¥½æ»´,æ•°æ®é›†å¤§æ¦‚å°±æ˜¯è¿™æ ·!æˆ‘ä»¬ç»ˆäºå¯ä»¥æ¥çœ‹ä¸€ä¸‹å…³äºConfigç›¸å…³çš„æ–‡ä»¶äº†.</p>
<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><p>æˆ‘è‡ªè®¤ä¸ºæˆ‘å½“æ—¶å†™å¾—å…³äºConfigçš„è§£é‡Šå·²ç»å¤Ÿè¯¦ç»†äº†ç›´åˆ°æˆ‘åˆçœ‹äº†ä¸€éç›¸å…³çš„<a href="https://mmdetection.readthedocs.io/en/latest/tutorials/config.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>,å‘ç°å½“æ—¶è§£é‡Šçš„æ¼æ´è¿˜æ˜¯éå¸¸å¤š,æ‰€ä»¥åœ¨è¿™é‡Œå¤šå†™ä¸€ç‚¹.</p>
<blockquote>
<p>We incorporate modular and inheritance design into our config system, which is convenient to conduct various experiments. If you wish to inspect the config file, you may run <code>python tools/misc/print_config.py /PATH/TO/CONFIG</code> to see the complete config.</p>
</blockquote>
<p>æ­£å¦‚ä¸Šé¢æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>python tools/misc/print_config.py /PATH/TO/CONFIG</code> å‘½ä»¤æ¥å¯¹æˆ‘ä»¬æƒ³è¦äº†è§£çš„configæ–‡ä»¶æ¥çœ‹ä»–ä»¬ç›¸å…³çš„å…·ä½“é…ç½®.<del>äºæˆ‘å½“æ—¶è¿˜ä¸“é—¨å†™äº†ä¸ªç›¸å…³çš„æ‰“å°é…ç½®ä»£ç â€¦</del></p>
<p>æŠ„ä¸€ä¸‹æˆ‘è‡ªå·±çš„blog:</p>
<blockquote>
<p>æˆ‘ä»¬çš„configéœ€è¦æ”¾åˆ°<code>configs/balloon/</code>ç›®å½•ä¸‹å¹¶ä¸”å‘½åä¸ºï¼š<code>mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py</code></p>
<p>å…³äºè¿™ä¹ˆä¸€ä¸ªåå­—ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå¤æ‚æ˜¯æœ‰åŸå› çš„ï¼Œå‚è§è¿™é‡Œ:<a href="https://mmdetection.readthedocs.io/zh_CN/v2.18.0/tutorials/config.html#id4" target="_blank" rel="noopener">https://mmdetection.readthedocs.io/zh_CN/v2.18.0/tutorials/config.html#id4</a></p>
</blockquote>
<p>å½“æ—¶çš„æˆ‘ä¹ŸçœŸæ˜¯å¤Ÿè¾›è‹¦,å®˜ç½‘ç»™çš„æŒºå¤šä¸œè¥¿éƒ½æœ‰é—®é¢˜,æˆ‘å½“æ—¶å°±è‡ªå·±ä¿®æ”¹äº†è®¸å¤šä¸œè¥¿,æ€»ç®—è®©æˆ‘ä»¬çš„balloon.pyæˆåŠŸè¿è¡Œäº†:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># The new config inherits a base config to highlight the necessary modification</span>
_base_ <span class="token operator">=</span> <span class="token string">'../mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py'</span>

<span class="token comment" spellcheck="true"># We also need to change the num_classes in head to match the dataset's annotation</span>
model <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    roi_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        bbox_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Modify dataset related settings</span>
dataset_type <span class="token operator">=</span> <span class="token string">'COCODataset'</span>
classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    train<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/train/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/train/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    val<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># We can use the pre-trained Mask RCNN model to obtain higher performance</span>
<span class="token comment" spellcheck="true"># load_from = 'checkpoints/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span>
load_from <span class="token operator">=</span> <span class="token string">'https://download.openmmlab.com/mmdetection/v2.0/mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å½“æ—¶å†™é‚£ç¯‡åšæ–‡<a href="https://lry89757.github.io/2021/10/12/practice-mmdet-customized-datasets/">practice mmdet(Customized datasets)</a>çš„æ—¶å€™,è¿˜æ²¡æœ‰å½»åº•è¯»æºç è¿›è¡Œç›¸å…³çš„æº¯æº,è€Œåœ¨æˆ‘æº¯æºä»£ç <a href="https://lry89757.github.io/2021/10/16/code-trace-of-mmdetection/">Code Trace of mmdetection</a>ä¹‹å,å¯¹æ•´ä¸ªå·¥ç¨‹çš„ç†è§£ä¸Šå‡äº†ä¸€ä¸ªå±‚æ¬¡,ä¸å¾—ä¸è¯´è¿˜çœŸæ˜¯å¤Ÿå¯ä»¥çš„,è¿˜æ˜¯å­¦å¥½ç›¸å…³çš„æ–‡ä»¶ã€è¯»æ‡‚æºç æ‰ç®—çœŸæ­£ç†è§£äº†å¾ˆå¤šä¸œè¥¿. è€Œå°½ç®¡è¯»äº†éƒ¨åˆ†æºç ä½†è¿˜æ˜¯ä¸çŸ¥å…¨å±€,æ­£æ˜¯å½“æˆ‘çœ‹äº†çŸ¥ä¹å®˜æ–¹å†™å¾—æ•´ä½“æ¡†æ¶åæ‰æ›´åŠ å…¨å±€äº†è§£äº†æœ‰å…³çš„ç»“æ„.å¯¹äºCVæ•´ä½“çš„æµç¨‹ç›®å‰ä¹Ÿæœ‰äº†æ›´å¥½çš„æŠŠæ¡.</p>
<p>ä¸Šé¢ä¸€æ®µæ‰¯äº†é‚£ä¹ˆå¤š,æˆ‘ä»¬æ¥è¿è¡Œå‘½ä»¤<code>python tools/misc/print_config.py /home/lry/projects/mmdetection/configs/balloon/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py</code>æ¥çœ‹çœ‹configåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿:<br>æˆ‘å…ˆæŠŠå¾—åˆ°çš„æ•´ä¸ªçš„ç»“æœå¤åˆ¶ä¸‹æ¥ä»¥ä¾¿å„ä½ç ”ç©¶:</p>
<pre class="line-numbers language-python"><code class="language-python">Config<span class="token punctuation">:</span>
model <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    type<span class="token operator">=</span><span class="token string">'MaskRCNN'</span><span class="token punctuation">,</span>
    backbone<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'ResNet'</span><span class="token punctuation">,</span>
        depth<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        num_stages<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        out_indices<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        frozen_stages<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        norm_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'BN'</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        norm_eval<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        style<span class="token operator">=</span><span class="token string">'caffe'</span><span class="token punctuation">,</span>
        init_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'Pretrained'</span><span class="token punctuation">,</span>
            checkpoint<span class="token operator">=</span><span class="token string">'open-mmlab://detectron2/resnet50_caffe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    neck<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'FPN'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        num_outs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    rpn_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'RPNHead'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        feat_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        anchor_generator<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'AnchorGenerator'</span><span class="token punctuation">,</span>
            scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bbox_coder<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>
            target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        loss_cls<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        loss_bbox<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    roi_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'StandardRoIHead'</span><span class="token punctuation">,</span>
        bbox_roi_extractor<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bbox_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>
            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            fc_out_channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
            roi_feat_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            bbox_coder<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>
                target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            reg_class_agnostic<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            loss_cls<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            loss_bbox<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_roi_extractor<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'FCNMaskHead'</span><span class="token punctuation">,</span>
            num_convs<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            conv_out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            loss_mask<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    train_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            allowed_border<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rpn_proposal<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mask_size<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            score_thr<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
            mask_thr_binary<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dataset_type <span class="token operator">=</span> <span class="token string">'COCODataset'</span>
data_root <span class="token operator">=</span> <span class="token string">'data/coco/'</span>
img_norm_cfg <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span>
        with_bbox<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        with_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        poly2mask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span>
        img_scale<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">672</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">704</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">736</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">768</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        multiscale_mode<span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">,</span>
        keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span> flip_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>
        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_bboxes'</span><span class="token punctuation">,</span> <span class="token string">'gt_labels'</span><span class="token punctuation">,</span> <span class="token string">'gt_masks'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>
        img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        transforms<span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>
                mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
data <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    samples_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    workers_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    train<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span>
        <span class="token string">'/home/lry/projects/mmdetection/data/balloon/train/annotation_coco.json'</span><span class="token punctuation">,</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/train/'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span>
                with_bbox<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                with_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                poly2mask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span>
                img_scale<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">672</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">704</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">736</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">768</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                multiscale_mode<span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">,</span>
                keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span> flip_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>
                mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span>
                keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_bboxes'</span><span class="token punctuation">,</span> <span class="token string">'gt_labels'</span><span class="token punctuation">,</span> <span class="token string">'gt_masks'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    val<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span>
        <span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/annotation_coco.json'</span><span class="token punctuation">,</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>
                img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                transforms<span class="token operator">=</span><span class="token punctuation">[</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>
                        type<span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>
                        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span>
        <span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/annotation_coco.json'</span><span class="token punctuation">,</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/balloon/val/'</span><span class="token punctuation">,</span>
        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>
            dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>
                img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                transforms<span class="token operator">=</span><span class="token punctuation">[</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>
                        type<span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>
                        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.53</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        to_rgb<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
evaluation <span class="token operator">=</span> dict<span class="token punctuation">(</span>metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">,</span> <span class="token string">'segm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span>
optimizer_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>grad_clip<span class="token operator">=</span>None<span class="token punctuation">)</span>
lr_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    policy<span class="token operator">=</span><span class="token string">'step'</span><span class="token punctuation">,</span>
    warmup<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>
    warmup_iters<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span>
    warmup_ratio<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>
    step<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
runner <span class="token operator">=</span> dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'EpochBasedRunner'</span><span class="token punctuation">,</span> max_epochs<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span>
checkpoint_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
log_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> hooks<span class="token operator">=</span><span class="token punctuation">[</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
custom_hooks <span class="token operator">=</span> <span class="token punctuation">[</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'NumClassCheckHook'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
dist_params <span class="token operator">=</span> dict<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'nccl'</span><span class="token punctuation">)</span>
log_level <span class="token operator">=</span> <span class="token string">'INFO'</span>
load_from <span class="token operator">=</span> <span class="token string">'https://download.openmmlab.com/mmdetection/v2.0/mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span>
resume_from <span class="token operator">=</span> None
workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ…¢æ…¢çœ‹,å®é™…ä¸Šå°±æ˜¯æ£€æµ‹åˆ†å‰²çš„å„ä¸ªç»“æ„æµç¨‹(backbone, neck, rpn_head, roi_head)ä»¥åŠæˆ‘ä»¬è®­ç»ƒéªŒè¯æ•°æ®çš„æ ¼å¼é¢„è®­ç»ƒæ–¹æ³•(train_cfg, data_type, data_root, train_pipeline, testâ€¦)ä»¥åŠå„ç±»å…³äºæƒé‡ä½ç½®ã€å­¦ä¹ ç‡ã€ä¼˜åŒ–å‡½æ•°ç­‰ç­‰â€¦:</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210515.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210526.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210532.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210556.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210539.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitee.com/moisten-the-rain/image01/raw/master/img/20211109210544.png" alt></p>
<p>é™¤äº†ä»¥ä¸Šç»“æ„ä¹‹å¤–,å‰©ä¸‹çš„å°±æ˜¯ä¸€äº›æˆ‘ä»¬çš„å…¶ä½™é…ç½®:</p>
<pre class="line-numbers language-python"><code class="language-python">evaluation <span class="token operator">=</span> dict<span class="token punctuation">(</span>metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">,</span> <span class="token string">'segm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span>
optimizer_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>grad_clip<span class="token operator">=</span>None<span class="token punctuation">)</span>
lr_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    policy<span class="token operator">=</span><span class="token string">'step'</span><span class="token punctuation">,</span>
    warmup<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>
    warmup_iters<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span>
    warmup_ratio<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>
    step<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
runner <span class="token operator">=</span> dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'EpochBasedRunner'</span><span class="token punctuation">,</span> max_epochs<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span>
checkpoint_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
log_config <span class="token operator">=</span> dict<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> hooks<span class="token operator">=</span><span class="token punctuation">[</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
custom_hooks <span class="token operator">=</span> <span class="token punctuation">[</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'NumClassCheckHook'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
dist_params <span class="token operator">=</span> dict<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'nccl'</span><span class="token punctuation">)</span>
log_level <span class="token operator">=</span> <span class="token string">'INFO'</span>
load_from <span class="token operator">=</span> <span class="token string">'https://download.openmmlab.com/mmdetection/v2.0/mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span>
resume_from <span class="token operator">=</span> None
workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="2021-11-10æ™šæ›´æ–°"><a href="#2021-11-10æ™šæ›´æ–°" class="headerlink" title="2021.11.10æ™šæ›´æ–°"></a>2021.11.10æ™šæ›´æ–°</h1><h2 id="Preface-1"><a href="#Preface-1" class="headerlink" title="Preface"></a>Preface</h2><p>æŒ‰ç…§æ˜¨å¤©çœ‹çš„è‡ªå·±ä¹‹å‰åšå®¢å’Œæ€»ç»“çš„æ€è·¯ï¼Œç›®å‰å½“åŠ¡ä¹‹æ€¥å°±æ˜¯æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ä»£ç æ¥è½¬æ¢labelmeæ ‡æ³¨çš„æ•°æ®é›†å˜ä¸ºCOCOæ ¼å¼çš„ï¼Œç›®å‰åœ¨GitHubæˆ‘æ‰¾åˆ°äº†ä¸€äº›ç›¸å…³çš„å¼€æºå°é¡¹ç›®ï¼Œæ‰“ç®—æ ¹æ®è¿™ä¸ªä»“åº“<a href="https://github.com/veraposeidon/labelme2Datasets" target="_blank" rel="noopener">https://github.com/veraposeidon/labelme2Datasets</a> æ¥è½¬æ¢æˆ‘ä»¬çš„æ•°æ®ï¼Œå½“ç„¶è¿™é‡Œè‚¯å®šéœ€è¦æ›´æ”¹ä¸€äº›ä»£ç ã€‚å¦å¤–è¿™é‡Œç”±äºåˆ†å‰²å¹¶æ²¡æœ‰åšæ•°æ®æ ‡æ³¨ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±å¾—é‡æ–°å†™ä¸€éåˆ†å‰²çš„ç›¸å…³æ ‡æ³¨ã€‚</p>
<blockquote>
<p>çœŸæ˜¯æ‡’å¾—å¤Ÿå¯ä»¥ï¼Œ11.10æ•´å®Œçš„ï¼Œè¦ç­‰åˆ°11.13å·æ¥å†™ï¼Œåäº†ã€‚</p>
</blockquote>
<h2 id="COCO-jsonå’ŒLabelme-jsonåŒºåˆ«"><a href="#COCO-jsonå’ŒLabelme-jsonåŒºåˆ«" class="headerlink" title="COCO.jsonå’ŒLabelme.jsonåŒºåˆ«"></a>COCO.jsonå’ŒLabelme.jsonåŒºåˆ«</h2><p><del>å¾…æ›´</del><br>2021.11.13å·²æ›´æ–°ã€‚</p>
<p>ä¸Šé¢æœ‰æåˆ°Labelme.jsonæ–‡ä»¶ä¸»è¦æ ¼å¼ï¼ŒCOCOæ•°æ®é›†å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">{</span>
    <span class="token string">"images"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"annotations"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>annotation<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"categories"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>category<span class="token punctuation">]</span>
<span class="token punctuation">}</span>


image <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"width"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"height"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"file_name"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

annotation <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"image_id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"category_id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"segmentation"</span><span class="token punctuation">:</span> RLE <span class="token operator">or</span> <span class="token punctuation">[</span>polygon<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"area"</span><span class="token punctuation">:</span> float<span class="token punctuation">,</span>
    <span class="token string">"bbox"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>width<span class="token punctuation">,</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"iscrowd"</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token operator">or</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
    <span class="token string">"supercategory"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>COCOçš„jsonæ–‡ä»¶æ˜¯æ‰€æœ‰å›¾ç‰‡éƒ½æ”¾åˆ°ä¸€ä¸ªjsonæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ç±»åˆ«ã€å›¾ç‰‡æå‰éƒ½ç”¨ç¼–å·idå®šä¹‰å¥½ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç»§ç»­çœ‹ä¸€ä¸‹Labelme.jsonæ–‡ä»¶åŒ…å«ä»€ä¹ˆï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"4.5.13"</span><span class="token punctuation">,</span>
  <span class="token string">"flags"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"shapes"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"label"</span><span class="token punctuation">:</span> <span class="token string">"780B"</span><span class="token punctuation">,</span>
      <span class="token string">"points"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
          <span class="token number">734.0</span><span class="token punctuation">,</span>
          <span class="token number">2425.0</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token number">2779.0</span><span class="token punctuation">,</span>
          <span class="token number">2355.0</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token number">2584.0</span><span class="token punctuation">,</span>
          <span class="token number">3580.0</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token number">819.0</span><span class="token punctuation">,</span>
          <span class="token number">3770.0</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"group_id"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
      <span class="token string">"shape_type"</span><span class="token punctuation">:</span> <span class="token string">"polygon"</span><span class="token punctuation">,</span>
      <span class="token string">"flags"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">{</span>
    <span class="token string">"label"</span><span class="token punctuation">:</span><span class="token string">"780B"</span><span class="token punctuation">,</span>
    <span class="token string">"points"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"group_id"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
      <span class="token string">"shape_type"</span><span class="token punctuation">:</span> <span class="token string">"polygon"</span><span class="token punctuation">,</span>
      <span class="token string">"flags"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"imagePath"</span><span class="token punctuation">:</span> <span class="token string">"IMG_20211021_154043.jpg"</span><span class="token punctuation">,</span>
  <span class="token string">"imageData"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
  <span class="token string">"imageHeight"</span><span class="token punctuation">:</span> <span class="token number">4608</span><span class="token punctuation">,</span>
  <span class="token string">"imageWidth"</span><span class="token punctuation">:</span> <span class="token number">3456</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>labelmeæ–‡ä»¶æ˜¯æ¯ä¸€ä¸ªå›¾ç‰‡éƒ½æœ‰è‡ªå·±çš„jsonæ–‡ä»¶è´Ÿè´£å­˜å‚¨å„ä¸ªå›¾ç‰‡ã€‚</p>
<p>å¦å¤–è¿™é‡Œä»‹ç»ä¸€ä¸‹COCOæ•°æ®é›†ä¸­çš„segmentationç±»å‹çš„labelæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå®é™…ä¸Šå°±æ˜¯ç±»ä¼¼äºå¤šè¾¹å½¢çš„æ¯ä¸€ä¸ªé¡¶ç‚¹è¿™ä¸ªæ ·å¼ï¼Œè¿™å¯¹æˆ‘ä»¬ç›®å‰çš„æ•°æ®é›†éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºæˆ‘ä»¬ç›®å‰æ•°æ®é›†å¹¶æ²¡æœ‰æ ‡æ³¨æ¯ä¸€ä¸ªç‰©ä½“çš„åˆ†å‰²æ•°æ®é›†ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç›®æ ‡æœ¬èº«å°±æ˜¯çŸ©å½¢æ¡†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ç”¨æ£€æµ‹çš„labelå°±å¯ä»¥ç›´æ¥è½¬åŒ–ä¸ºCOCOæ ¼å¼çš„åˆ†å‰²çš„labelã€‚å› ä¸ºéƒ½æ˜¯åªæœ‰4ä¸ªç‚¹å°±å¯ä»¥ã€‚</p>
<h2 id="è½¬æ¢æºç åˆå§‹ç‰ˆ"><a href="#è½¬æ¢æºç åˆå§‹ç‰ˆ" class="headerlink" title="è½¬æ¢æºç åˆå§‹ç‰ˆ"></a>è½¬æ¢æºç åˆå§‹ç‰ˆ</h2><p>ç›®å‰æ‰“ç®—è½¬æ¢çš„æºç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—ç”¨äºæ‰¹é‡è½¬æ¢labelmeæ ‡è®°çš„æ ¼å¼ï¼Œä½¿ä¹‹å˜æˆcocoæ•°æ®é›†æ ¼å¼"""</span>
<span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># !/usr/bin/env python</span>


<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> json
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> skimage<span class="token punctuation">.</span>io <span class="token keyword">as</span> io
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> labelme <span class="token keyword">import</span> utils
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> PIL<span class="token punctuation">.</span>Image


<span class="token keyword">class</span> <span class="token class-name">MyEncoder</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>JSONEncoder<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">default</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>integer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> int<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>floating<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> float<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> super<span class="token punctuation">(</span>MyEncoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">labelme2coco</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> labelme_json<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> save_json_path<span class="token operator">=</span><span class="token string">'./tran.json'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        labelme_json: æ‰€æœ‰labelmeçš„jsonæ–‡ä»¶è·¯å¾„ç»„æˆçš„åˆ—è¡¨
        save_json_path: jsonä¿å­˜ä½ç½®
        '''</span>
        self<span class="token punctuation">.</span>labelme_json <span class="token operator">=</span> labelme_json
        self<span class="token punctuation">.</span>save_json_path <span class="token operator">=</span> save_json_path
        self<span class="token punctuation">.</span>images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>annotations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># self.data_coco = {}</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>annID <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>save_json<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">data_transfer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">for</span> num<span class="token punctuation">,</span> json_file <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>labelme_json<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"num:"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'    '</span> <span class="token operator">+</span> json_file<span class="token punctuation">)</span>
            <span class="token keyword">with</span> open<span class="token punctuation">(</span>json_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
                data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># åŠ è½½jsonæ–‡ä»¶</span>
                self<span class="token punctuation">.</span>images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">(</span>data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> shapes <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'shapes'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    label <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> label <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>label<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>categories<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>categorie<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
                    points <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># è¿™é‡Œçš„pointæ˜¯ç”¨rectangleæ ‡æ³¨å¾—åˆ°çš„ï¼Œåªæœ‰ä¸¤ä¸ªç‚¹ï¼Œéœ€è¦è½¬æˆå››ä¸ªç‚¹</span>
                    <span class="token comment" spellcheck="true">#points.append([points[0][0], points[1][1]])</span>
                    <span class="token comment" spellcheck="true">#points.append([points[1][0], points[0][1]])</span>
                    self<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>annotation<span class="token punctuation">(</span>points<span class="token punctuation">,</span> label<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>annID <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        img <span class="token operator">=</span> utils<span class="token punctuation">.</span>img_b64_to_arr<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'imageData'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># è§£æåŸå›¾ç‰‡æ•°æ®</span>
        <span class="token comment" spellcheck="true"># img=io.imread(data['imagePath']) # é€šè¿‡å›¾ç‰‡è·¯å¾„æ‰“å¼€å›¾ç‰‡</span>
        <span class="token comment" spellcheck="true"># img = cv2.imread(data['imagePath'], 0)</span>
        height<span class="token punctuation">,</span> width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        img <span class="token operator">=</span> None
        image<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">=</span> height
        image<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">=</span> width
        image<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true">#image['file_name'] = data['imagePath'].split("\\")[-1] #æ­¤è¡Œä¸é€‚åˆæˆ‘çš„æ•°æ®é›†</span>
        image<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'imagePath'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>height <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> width

        <span class="token keyword">return</span> image

    <span class="token keyword">def</span> <span class="token function">categorie</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
        categorie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        categorie<span class="token punctuation">[</span><span class="token string">'supercategory'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Cancer'</span>
        categorie<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment" spellcheck="true"># 0 é»˜è®¤ä¸ºèƒŒæ™¯</span>
        categorie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> label
        <span class="token keyword">return</span> categorie

    <span class="token keyword">def</span> <span class="token function">annotation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> points<span class="token punctuation">,</span> label<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        annotation <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        annotation<span class="token punctuation">[</span><span class="token string">'segmentation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>list<span class="token punctuation">(</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        annotation<span class="token punctuation">[</span><span class="token string">'iscrowd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        annotation<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true"># annotation['bbox'] = str(self.getbbox(points)) # ä½¿ç”¨listä¿å­˜jsonæ–‡ä»¶æ—¶æŠ¥é”™ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</span>
        <span class="token comment" spellcheck="true"># list(map(int,a[1:-1].split(','))) a=annotation['bbox'] ä½¿ç”¨è¯¥æ–¹å¼è½¬æˆlist</span>
        annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span>float<span class="token punctuation">,</span> self<span class="token punctuation">.</span>getbbox<span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation<span class="token punctuation">[</span><span class="token string">'area'</span><span class="token punctuation">]</span> <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># annotation['category_id'] = self.getcatid(label)</span>
        annotation<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>getcatid<span class="token punctuation">(</span>label<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„ï¼Œæºä»£ç é»˜è®¤ä¸º1</span>
        annotation<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>annID
        <span class="token keyword">return</span> annotation

    <span class="token keyword">def</span> <span class="token function">getcatid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> categorie <span class="token keyword">in</span> self<span class="token punctuation">.</span>categories<span class="token punctuation">:</span>
            <span class="token keyword">if</span> label <span class="token operator">==</span> categorie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> categorie<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">getbbox</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># img = np.zeros([self.height,self.width],np.uint8)</span>
        <span class="token comment" spellcheck="true"># cv2.polylines(img, [np.asarray(points)], True, 1, lineType=cv2.LINE_AA)  # ç”»è¾¹ç•Œçº¿</span>
        <span class="token comment" spellcheck="true"># cv2.fillPoly(img, [np.asarray(points)], 1)  # ç”»å¤šè¾¹å½¢ å†…éƒ¨åƒç´ å€¼ä¸º1</span>
        polygons <span class="token operator">=</span> points

        mask <span class="token operator">=</span> self<span class="token punctuation">.</span>polygons_to_mask<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>height<span class="token punctuation">,</span> self<span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">,</span> polygons<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#print(polygons)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>mask2box<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">mask2box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''ä»maskåç®—å‡ºå…¶è¾¹æ¡†
        maskï¼š[h,w]  0ã€1ç»„æˆçš„å›¾ç‰‡
        1å¯¹åº”å¯¹è±¡ï¼Œåªéœ€è®¡ç®—1å¯¹åº”çš„è¡Œåˆ—å·ï¼ˆå·¦ä¸Šè§’è¡Œåˆ—å·ï¼Œå³ä¸‹è§’è¡Œåˆ—å·ï¼Œå°±å¯ä»¥ç®—å‡ºå…¶è¾¹æ¡†ï¼‰
        '''</span>
        <span class="token comment" spellcheck="true"># np.where(mask==1)</span>
        index <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#print(index)</span>


        rows <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        clos <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># è§£æå·¦ä¸Šè§’è¡Œåˆ—å·</span>
        <span class="token comment" spellcheck="true">#print(rows)</span>
        left_top_r <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>rows<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># y</span>
        left_top_c <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>clos<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># x</span>

        <span class="token comment" spellcheck="true"># è§£æå³ä¸‹è§’è¡Œåˆ—å·</span>
        right_bottom_r <span class="token operator">=</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
        right_bottom_c <span class="token operator">=</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>clos<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># return [(left_top_r,left_top_c),(right_bottom_r,right_bottom_c)]</span>
        <span class="token comment" spellcheck="true"># return [(left_top_c, left_top_r), (right_bottom_c, right_bottom_r)]</span>
        <span class="token comment" spellcheck="true"># return [left_top_c, left_top_r, right_bottom_c, right_bottom_r]  # [x1,y1,x2,y2]</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>left_top_c<span class="token punctuation">,</span> left_top_r<span class="token punctuation">,</span> right_bottom_c <span class="token operator">-</span> left_top_c<span class="token punctuation">,</span>
                right_bottom_r <span class="token operator">-</span> left_top_r<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># [x1,y1,w,h] å¯¹åº”COCOçš„bboxæ ¼å¼</span>

    <span class="token keyword">def</span> <span class="token function">polygons_to_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_shape<span class="token punctuation">,</span> polygons<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>img_shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        mask <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
        xy <span class="token operator">=</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span>tuple<span class="token punctuation">,</span> polygons<span class="token punctuation">)</span><span class="token punctuation">)</span>
        PIL<span class="token punctuation">.</span>ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span>polygon<span class="token punctuation">(</span>xy<span class="token operator">=</span>xy<span class="token punctuation">,</span> outline<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        mask <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> dtype<span class="token operator">=</span>bool<span class="token punctuation">)</span>
        <span class="token keyword">return</span> mask

    <span class="token keyword">def</span> <span class="token function">data2coco</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_coco <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        data_coco<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>images
        data_coco<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>categories
        data_coco<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>annotations
        <span class="token keyword">return</span> data_coco

    <span class="token keyword">def</span> <span class="token function">save_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_transfer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data_coco <span class="token operator">=</span> self<span class="token punctuation">.</span>data2coco<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># ä¿å­˜jsonæ–‡ä»¶</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_coco<span class="token punctuation">,</span> open<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> cls<span class="token operator">=</span>MyEncoder<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># indent=4 æ›´åŠ ç¾è§‚æ˜¾ç¤º</span>


labelme_json <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'H:/camellia/Aug/è®­ç»ƒ/val_json/*.json'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>labelme_json<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># labelme_json=['./Annotations/*.json']</span>
<span class="token comment" spellcheck="true"># labelme_json=glob.glob('./Annotations/*.json')</span>

saveme_json <span class="token operator">=</span> <span class="token string">'H:/camellia/Aug/è®­ç»ƒ/annotations/val.json'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Start."</span><span class="token punctuation">)</span>

labelme2coco<span class="token punctuation">(</span>labelme_json<span class="token punctuation">,</span> saveme_json<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finished."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ä»£ç è¯¦è§£"><a href="#ä»£ç è¯¦è§£" class="headerlink" title="ä»£ç è¯¦è§£"></a>ä»£ç è¯¦è§£</h2><p>æŒ‰ç…§è¿è¡Œé¡ºåºæ¥è§£é‡Šä»£ç ï¼š</p>
<h3 id="main"><a href="#main" class="headerlink" title="main()"></a>main()</h3><p>å…³äºä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿è¡Œçš„é¡ºåºæ¥å®šä¹‰ï¼Œé¦–å…ˆæ˜¯globäº†æ‰€æœ‰.jsonå‰ç¼€çš„æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬labelmeçš„æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªå›¾ç‰‡ä¸“é—¨ç”Ÿæˆä¸€ä¸ª.jsonæ–‡ä»¶ï¼Œè€Œæˆ‘ä»¬çš„COCOæ•°æ®é›†æ ¼å¼æ˜¯æ‰€æœ‰çš„å›¾ç‰‡çš„ä¿¡æ¯éƒ½æ”¾åˆ°äº†ä¸€ä¸ª.jsonå›¾ç‰‡ä¸­ï¼Œæ¥ç€æˆ‘ä»¬å®šä¹‰ä¿å­˜åˆ°çš„jsonæ–‡ä»¶ï¼Œç„¶åç›´æ¥è°ƒç”¨ç±»labelme2coco,ç„¶åç›´æ¥å¾—åˆ°çš„ç»“æœã€‚</p>
<h3 id="labelme2coco"><a href="#labelme2coco" class="headerlink" title="labelme2coco"></a>labelme2coco</h3><p>labelme2cocoæ˜¯æ•´ä¸ªæ–‡ä»¶çš„å…³é”®ã€‚</p>
<h3 id="init"><a href="#init" class="headerlink" title="__init__"></a><code>__init__</code></h3><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">labelme2coco</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> labelme_json<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> save_json_path<span class="token operator">=</span><span class="token string">'./tran.json'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># è¿™é‡Œå®šä¹‰äº†é»˜è®¤çš„å­˜å‚¨è·¯å¾„</span>
        <span class="token triple-quoted-string string">'''
        labelme_json: æ‰€æœ‰labelmeçš„jsonæ–‡ä»¶è·¯å¾„ç»„æˆçš„åˆ—è¡¨
        save_json_path: jsonä¿å­˜ä½ç½®
        '''</span>
        self<span class="token punctuation">.</span>labelme_json <span class="token operator">=</span> labelme_json     <span class="token comment" spellcheck="true"># labelme_jsonçš„æ–‡ä»¶è·¯å¾„ï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å­˜å‚¨ç€æ‰€æœ‰çš„å¾…è½¬åŒ–jsonæ–‡ä»¶è·¯å¾„</span>
        self<span class="token punctuation">.</span>save_json_path <span class="token operator">=</span> save_json_path  <span class="token comment" spellcheck="true"># ä¿å­˜çš„è·¯å¾„</span>
        self<span class="token punctuation">.</span>images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># å¯¹åº”ç”ŸæˆCOCOå½¢å¼jsonæ–‡ä»¶çš„imageçš„ç±»å‹ã€‚</span>
        self<span class="token punctuation">.</span>categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># åŒä¸Š</span>
        self<span class="token punctuation">.</span>annotations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># åŒä¸Š</span>
        <span class="token comment" spellcheck="true"># self.data_coco = {}</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>annID <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>save_json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„è¿™é‡Œä¸€è°ƒç”¨è¯¥ç±»å°±ç›´æ¥è¿è¡Œç›¸å…³çš„æ‰€æœ‰ä»£ç äº†ï¼Œè¿™ä¸ªæŠ€å·§å¾ˆæœ‰ç”¨ã€‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥åº”è¯¥çœ‹<code>save_json()</code>ï¼š</p>
<h3 id="save-json"><a href="#save-json" class="headerlink" title="save_json()"></a>save_json()</h3><pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">save_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_transfer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data_coco <span class="token operator">=</span> self<span class="token punctuation">.</span>data2coco<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># ä¿å­˜jsonæ–‡ä»¶</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_coco<span class="token punctuation">,</span> open<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> cls<span class="token operator">=</span>MyEncoder<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># indent=4 æ›´åŠ ç¾è§‚æ˜¾ç¤º</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªå¯ä»¥çœ‹åˆ°å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªè°ƒç”¨çš„ç±»å†…çš„å‡½æ•°æ¥æ€»ä½“è°ƒç”¨ã€‚æˆ‘ä»¬ç»§ç»­æ¥çœ‹data_transfer()</p>
<h3 id="data-transfer"><a href="#data-transfer" class="headerlink" title="data_transfer()"></a>data_transfer()</h3><pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">data_transfer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">for</span> num<span class="token punctuation">,</span> json_file <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>labelme_json<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"num:"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'    '</span> <span class="token operator">+</span> json_file<span class="token punctuation">)</span>
            <span class="token keyword">with</span> open<span class="token punctuation">(</span>json_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
                data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># åŠ è½½jsonæ–‡ä»¶</span>
                self<span class="token punctuation">.</span>images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">(</span>data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„è¿™ä¸ªimageæ˜¯ä¸ªå‡½æ•°ï¼ å°†è¯¥å›¾ç‰‡çš„æ‰€æœ‰ç›¸åº”çš„ä¿¡æ¯è½¬åŒ–ä¸ºCOCOçš„imageæ ¼å¼</span>
                <span class="token keyword">for</span> shapes <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'shapes'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true"># shapesæ˜¯ä¸»è¦çš„æ ‡æ³¨ä¿¡æ¯ï¼Œæˆ‘ä»¬é‡ç‚¹å°±æ˜¯è¯»å–è¿™ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰å¿…è¦è¯»å–æ‰€æœ‰ï¼Œå¯èƒ½åªéœ€è¦è¯»å–ç¬¬ä¸€ä¸ª780bå°±å¯ä»¥</span>
                    label <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯å°†æ‰€æœ‰çš„labelæœ‰å…³æ–‡ä»¶éƒ½å¾ªç¯äº†ä¸€é</span>
                    <span class="token keyword">if</span> label <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>label<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>categories<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>categorie<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„è¿™ä¸ªself.categorieä¹Ÿæ˜¯ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªä»£ç æ®µå°±æ˜¯è¦ç”ŸæˆCOCOçš„categoriesæ ¼å¼</span>
                        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
                    points <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># è¿™é‡Œçš„pointæ˜¯ç”¨rectangleæ ‡æ³¨å¾—åˆ°çš„ï¼Œåªæœ‰ä¸¤ä¸ªç‚¹ï¼Œéœ€è¦è½¬æˆå››ä¸ªç‚¹</span>
                    <span class="token comment" spellcheck="true">#points.append([points[0][0], points[1][1]])</span>
                    <span class="token comment" spellcheck="true">#points.append([points[1][0], points[0][1]])</span>
                    self<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>annotation<span class="token punctuation">(</span>points<span class="token punctuation">,</span> label<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># åŒæ ·çš„ï¼Œself.annotationä¹Ÿæ˜¯ä¸€ä¸ªç›¸åº”çš„å‡½æ•°è¦å°†æ‰€ç»™çš„pointsæ–‡ä»¶è½¬åŒ–ä¸ºannotationå’Œsegmentationæ–‡ä»¶</span>
                    self<span class="token punctuation">.</span>annID <span class="token operator">+=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œä¸€æ­¥ä¸€æ­¥è¯´ï¼Œé¦–å…ˆå°±æ˜¯è¦å°†æ‰€æœ‰çš„jsonæ–‡ä»¶å¾ªç¯éå†ä¸€éï¼Œä¹‹åæ‰“å¼€æ¯ä¸ªæ–‡ä»¶ï¼Œé¦–å…ˆåŠ è½½æ–‡ä»¶ï¼Œä¹‹åè°ƒç”¨ç±»ä¸­å®šä¹‰å¥½çš„self.image()å‡½æ•°,è¿™ä¸ªå‡½æ•°å°†è¯¥å›¾ç‰‡æ‰€æœ‰ç›¸åº”çš„ä¿¡æ¯è½¬åŒ–æˆCOCOçš„imageçš„æ ¼å¼ç„¶åè¿”å›COCOæ ¼å¼çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä¿¡æ¯åŠ åˆ°self.imagesä¸­å»ã€‚æˆ‘ä»¬å…ˆè§£æä¸€ä¸‹ç›¸å…³çš„self.image()å‡½æ•°ã€‚</p>
<h3 id="image"><a href="#image" class="headerlink" title="image()"></a>image()</h3><p>å®é™…ä¸Šimage()éœ€è¦çš„ä¿¡æ¯ä¹Ÿå°±æ˜¯ä¸€ä¸ªå›¾ç‰‡çš„é«˜å®½ã€å°†å›¾ç‰‡æ•´ç†æˆç¼–å·ï¼Œå›¾ç‰‡åã€‚</p>
<pre class="line-numbers language-python"><code class="language-python">image <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"width"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"height"</span><span class="token punctuation">:</span> int<span class="token punctuation">,</span>
    <span class="token string">"file_name"</span><span class="token punctuation">:</span> str<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>imageå‡½æ•°å®é™…ä¸Šå°±æ˜¯è¯»å–äº†ä»¥ä¸Šçš„æä¾›çš„ä¿¡æ¯ç„¶åè½¬åŒ–è¿‡å»ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        img <span class="token operator">=</span> utils<span class="token punctuation">.</span>img_b64_to_arr<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'imageData'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># è§£æåŸå›¾ç‰‡æ•°æ®ï¼Œæ³¨æ„æˆ‘ä»¬å¹¶ä¸æ˜¯æ‰€æœ‰æ–‡ä»¶éƒ½æœ‰,æ€ªä¸å¾—æ‰€æœ‰æ–‡ä»¶éƒ½æ‰“å¼€è¿è¡Œä¼šæŠ¥é”™ï¼ŒçœŸæ˜¯å¥½å¥‡æ€ªï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶è·¯å¾„æ‰“å¼€ï¼Œå‚è§ä¸‹ä¸€è¡Œä»£ç </span>
        <span class="token comment" spellcheck="true"># img=io.imread(os.path.join(root, data['imagePath'])) # é€šè¿‡å›¾ç‰‡è·¯å¾„æ‰“å¼€å›¾ç‰‡ï¼Œ ä¸è¿‡è¿™ä¸ªå°±éœ€è¦è®¾ä¸€ä¸ªå…¨å±€çš„root</span>
        <span class="token comment" spellcheck="true"># img = cv2.imread(data['imagePath'], 0)</span>
        height<span class="token punctuation">,</span> width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        img <span class="token operator">=</span> None
        image<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">=</span> height
        image<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">=</span> width
        image<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true">#image['file_name'] = data['imagePath'].split("\\")[-1] #æ­¤è¡Œä¸é€‚åˆæˆ‘çš„æ•°æ®é›†</span>
        image<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'imagePath'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>height <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> width

        <span class="token keyword">return</span> image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ³¨æ„åˆ°æˆ‘ä»¬æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªå­—å…¸ã€‚<br>è¿™é‡Œæˆ‘ä»¬å‘ç°ç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•°utils.img_b64_to_arr()ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å°†æˆ‘ä»¬çš„å›¾ç‰‡è¯»å–æˆcv2çš„imgæ ¼å¼çŸ©é˜µï¼Œè¿™ä¸ªutilså®é™…ä¸Šæ˜¯labelmeè¿™ä¸ªåº“ä¸­çš„ä¸€ä¸ªæ¨¡å—ã€‚ç›®å‰æˆ‘çš„ç†è§£æ˜¯ï¼Œlabelmeç”Ÿæˆçš„.jsonæ–‡ä»¶é‡Œé¢çš„imageDataæ˜¯ä¸€å †æˆ‘çœ‹ä¸æ‡‚çš„ç¼–ç ï¼Œè¿™äº›ç¼–ç å®é™…ä¸Šå­˜å‚¨çš„å°±æ˜¯å›¾ç‰‡çš„ä¿¡æ¯ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡<code>img_b64_to_arr()</code>å‡½æ•°æ¥â€œç¿»è¯‘â€ä¸ºæˆ‘ä»¬èƒ½çœ‹æ‡‚çš„å›¾ç‰‡RGBçŸ©é˜µå½¢å¼å­˜å‚¨ã€‚<br>å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ³¨é‡Šä¹Ÿç»™å‡ºäº†ä¸€äº›å…¶ä»–æ–¹å¼çš„æ‰“å¼€å›¾ç‰‡å½¢å¼ï¼Œæœ‰ç”¨cv2è¯»å–ï¼Œæœ‰ç”¨skimage.ioè¯»å–çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬data[â€˜imageDataâ€™]çš„å€¼ä¸ºnull(<del>æˆ‘ç›®å‰é¡¹ç›®çš„æ•°æ®é›†å°±æ˜¯è¿™æ ·</del>)ã€‚å…¶ä»–çš„æ ¼å¼éƒ½æ˜¯å¾ˆç®€å•çš„å¤åˆ¶äº†ï¼Œç›¸å¯¹è€Œè¨€ä¸ç”¨å¤šè¯´ã€‚</p>
<h3 id="data-transfer-1"><a href="#data-transfer-1" class="headerlink" title="data_transfer()"></a>data_transfer()</h3><p>å¥½äº†æˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­è¯´æˆ‘ä»¬çš„data_transfer()å‡½æ•°ã€‚æ¥ä¸‹æ¥æ˜¯å¯¹data[â€˜shapesâ€™]æ‰€æœ‰æ–‡ä»¶è¿›è¡Œä¸€ä¸ªéå†ï¼Œshapesæ˜¯ä¸»è¦çš„æ ‡æ³¨ä¿¡æ¯ï¼Œæˆ‘ä»¬é‡ç‚¹å°±æ˜¯è¯»å–è¿™ä¸ªï¼Œshapesé‡Œé¢åŒ…å«ç€æ‰€æœ‰çš„æ ‡æ³¨æ¡†ground truthä¿¡æ¯ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œå› ä¸ºä»…ä»…å¯¹ä¸€ä¸ªå¤§æ¡†åšåˆ†å‰²æ‰€ä»¥åªéœ€è¦ä¸€ä¸ª780Bçš„labelå°±å¯ä»¥ï¼Œè¿™é‡Œå®ƒå°†æ‰€æœ‰éƒ½éå†äº†ä¸€éï¼Œç„¶åè°ƒç”¨äº†self.categorieå‡½æ•°æ¥è®©æˆ‘ä»¬çš„labelé‡Œé¢çš„ä¿¡æ¯è½¬åŒ–ä¸ºCOCOæ ¼å¼çš„ã€‚å®é™…ä¸Šå°±æ˜¯å˜ä¸ºCOCOæ ¼å¼jsonæ–‡ä»¶ä¸­é‚£ä¸ªcategoriesç±»å‹ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹self.categorie()</p>
<h3 id="categorie"><a href="#categorie" class="headerlink" title="categorie()"></a>categorie()</h3><pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">categorie</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
        categorie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        categorie<span class="token punctuation">[</span><span class="token string">'supercategory'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Cancer'</span>
        categorie<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment" spellcheck="true"># 0 é»˜è®¤ä¸ºèƒŒæ™¯</span>
        categorie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> label
        <span class="token keyword">return</span> categorie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®é™…ä¸Šéå¸¸ç®€å•ï¼Œå› ä¸ºCOCOé‡Œé¢çš„categoriesåªéœ€è¦çŸ¥é“æ•´ä¸ªæ•°æ®é›†æœ‰å“ªäº›ç±»ï¼Œæ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„idå°±OKäº†ã€‚</p>
<h3 id="data-transfer-2"><a href="#data-transfer-2" class="headerlink" title="data_transfer()"></a>data_transfer()</h3><p>å®é™…ä¸Šåé¢éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå¯¹åº”çš„åŠŸèƒ½è°ƒç”¨ç›¸åº”çš„å‡½æ•°å°±OKã€‚è¿™é‡Œä¸è¯¦ç»†è°ˆäº†ï¼Œæ²¡æœ‰å¿…è¦è¯¦ç»†è§£é‡Šã€‚</p>
<h3 id="data2coco"><a href="#data2coco" class="headerlink" title="data2coco()"></a>data2coco()</h3><p>éšåæˆ‘ä»¬çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†ç›¸å…³çš„å‡½æ•°è½¬åŒ–ä¸ºjsonæ–‡ä»¶éœ€è¦çš„å­—å…¸æ ¼å¼ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">data2coco</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_coco <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        data_coco<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>images
        data_coco<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>categories
        data_coco<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>annotations
        <span class="token keyword">return</span> data_coco<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€åè¿›è¡Œä¸€ä¸‹json.dumpå°±æˆåŠŸä¿å­˜å¥½jsonæ–‡ä»¶äº†ã€‚</p>
<h2 id="è½¬åŒ–ä»£ç æœ€ç»ˆæ”¹è‰¯ç‰ˆ"><a href="#è½¬åŒ–ä»£ç æœ€ç»ˆæ”¹è‰¯ç‰ˆ" class="headerlink" title="è½¬åŒ–ä»£ç æœ€ç»ˆæ”¹è‰¯ç‰ˆ"></a>è½¬åŒ–ä»£ç æœ€ç»ˆæ”¹è‰¯ç‰ˆ</h2><p>ç»è¿‡ä¸Šè¿°æè¿°ï¼Œæœ€ç»ˆåšä¸€ä¸ªæ”¹è‰¯ï¼Œå¾—åˆ°ç›¸åº”çš„ç»“æœï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—ç”¨äºæ‰¹é‡è½¬æ¢labelmeæ ‡è®°çš„æ ¼å¼ï¼Œä½¿ä¹‹å˜æˆcocoæ•°æ®é›†æ ¼å¼"""</span>
<span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-</span>
<span class="token comment" spellcheck="true"># !/usr/bin/env python</span>


<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> json
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> skimage<span class="token punctuation">.</span>io <span class="token keyword">as</span> io
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> labelme <span class="token keyword">import</span> utils
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> PIL<span class="token punctuation">.</span>Image
<span class="token keyword">import</span> os


<span class="token keyword">class</span> <span class="token class-name">MyEncoder</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>JSONEncoder<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">default</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>integer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> int<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>floating<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> float<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> super<span class="token punctuation">(</span>MyEncoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">labelme2coco</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> labelme_json<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> save_json_path<span class="token operator">=</span><span class="token string">'./tran.json'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># è¿™é‡Œå®šä¹‰äº†é»˜è®¤çš„å­˜å‚¨è·¯å¾„</span>
        <span class="token triple-quoted-string string">'''
        labelme_json: æ‰€æœ‰labelmeçš„jsonæ–‡ä»¶è·¯å¾„ç»„æˆçš„åˆ—è¡¨
        save_json_path: jsonä¿å­˜ä½ç½®
        '''</span>
        self<span class="token punctuation">.</span>labelme_json <span class="token operator">=</span> labelme_json     <span class="token comment" spellcheck="true"># labelme_jsonçš„æ–‡ä»¶è·¯å¾„ï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å­˜å‚¨ç€æ‰€æœ‰çš„å¾…è½¬åŒ–jsonæ–‡ä»¶è·¯å¾„</span>
        self<span class="token punctuation">.</span>save_json_path <span class="token operator">=</span> save_json_path  <span class="token comment" spellcheck="true"># ä¿å­˜çš„è·¯å¾„</span>
        self<span class="token punctuation">.</span>images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># å¯¹åº”ç”ŸæˆCOCOå½¢å¼jsonæ–‡ä»¶çš„imageçš„ç±»å‹ã€‚</span>
        self<span class="token punctuation">.</span>categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># åŒä¸Š</span>
        self<span class="token punctuation">.</span>annotations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># åŒä¸Š</span>
        <span class="token comment" spellcheck="true"># self.data_coco = {}</span>
        self<span class="token punctuation">.</span>label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>annID <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'/home/lry/projects/mmdetection/data/780b/'</span>

        self<span class="token punctuation">.</span>save_json<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„è¿™é‡Œä¸€è°ƒç”¨è¯¥ç±»å°±ç›´æ¥è¿è¡Œç›¸å…³çš„æ‰€æœ‰ä»£ç äº†ï¼Œè¿™ä¸ªæŠ€å·§å¾ˆæœ‰ç”¨ã€‚</span>

    <span class="token keyword">def</span> <span class="token function">data_transfer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">for</span> num<span class="token punctuation">,</span> json_file <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>labelme_json<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"num:"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'    '</span> <span class="token operator">+</span> json_file<span class="token punctuation">)</span>
            <span class="token keyword">with</span> open<span class="token punctuation">(</span>json_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
                data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># åŠ è½½jsonæ–‡ä»¶</span>
                <span class="token comment" spellcheck="true"># æ³¨æ„è¿™ä¸ªimageæ˜¯ä¸ªå‡½æ•°ï¼ å°†è¯¥å›¾ç‰‡çš„æ‰€æœ‰ç›¸åº”çš„ä¿¡æ¯è½¬åŒ–ä¸ºCOCOçš„imageæ ¼å¼</span>
                self<span class="token punctuation">.</span>images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>image<span class="token punctuation">(</span>data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token comment" spellcheck="true"># shapesæ˜¯ä¸»è¦çš„æ ‡æ³¨ä¿¡æ¯ï¼Œæˆ‘ä»¬é‡ç‚¹å°±æ˜¯è¯»å–è¿™ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰å¿…è¦è¯»å–æ‰€æœ‰ï¼Œå¯èƒ½åªéœ€è¦è¯»å–ç¬¬ä¸€ä¸ª780bå°±å¯ä»¥</span>
                <span class="token keyword">for</span> shapes <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'shapes'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>

                    <span class="token comment" spellcheck="true"># é¦–å…ˆæˆ‘ä»¬ä¼šåˆ¤æ–­æ˜¯å¦è¿™ä¸ªlabelæ˜¯å¦æ˜¯"780B"</span>
                    <span class="token keyword">if</span> shapes<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"780B"</span><span class="token punctuation">:</span>
                        <span class="token keyword">continue</span>

                    <span class="token comment" spellcheck="true"># æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯å°†æ‰€æœ‰çš„labelæœ‰å…³æ–‡ä»¶éƒ½å¾ªç¯äº†ä¸€é</span>
                    label <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>
                    <span class="token keyword">if</span> label <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>label<span class="token punctuation">:</span>
                        <span class="token comment" spellcheck="true"># æ³¨æ„è¿™ä¸ªself.categorieä¹Ÿæ˜¯ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªä»£ç æ®µå°±æ˜¯è¦ç”ŸæˆCOCOçš„categoriesæ ¼å¼</span>
                        self<span class="token punctuation">.</span>categories<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>categorie<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true"># è¿™é‡Œçš„pointæ˜¯ç”¨rectangleæ ‡æ³¨å¾—åˆ°çš„ï¼Œåªæœ‰ä¸¤ä¸ªç‚¹ï¼Œéœ€è¦è½¬æˆå››ä¸ªç‚¹</span>
                    points <span class="token operator">=</span> shapes<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span>
                    <span class="token comment" spellcheck="true">#points.append([points[0][0], points[1][1]])</span>
                    <span class="token comment" spellcheck="true">#points.append([points[1][0], points[0][1]])</span>
                    <span class="token comment" spellcheck="true"># åŒæ ·çš„ï¼Œself.annotationä¹Ÿæ˜¯ä¸€ä¸ªç›¸åº”çš„å‡½æ•°è¦å°†æ‰€ç»™çš„pointsæ–‡ä»¶è½¬åŒ–ä¸ºannotationå’Œsegmentationæ–‡ä»¶</span>
                    self<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                        self<span class="token punctuation">.</span>annotation<span class="token punctuation">(</span>points<span class="token punctuation">,</span> label<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>annID <span class="token operator">+=</span> <span class="token number">1</span>


    <span class="token keyword">def</span> <span class="token function">image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true"># è§£æåŸå›¾ç‰‡æ•°æ®ï¼Œæ³¨æ„æˆ‘ä»¬å¹¶ä¸æ˜¯æ‰€æœ‰æ–‡ä»¶éƒ½æœ‰,æ€ªä¸å¾—æ‰€æœ‰æ–‡ä»¶éƒ½æ‰“å¼€è¿è¡Œä¼šæŠ¥é”™ï¼ŒçœŸæ˜¯å¥½å¥‡æ€ªï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶è·¯å¾„æ‰“å¼€ï¼Œå‚è§ä¸‹ä¸€è¡Œä»£ç </span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> utils<span class="token punctuation">.</span>img_b64_to_arr<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'imageData'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            img<span class="token operator">=</span>io<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'imagePath'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># é€šè¿‡å›¾ç‰‡è·¯å¾„æ‰“å¼€å›¾ç‰‡ï¼Œ ä¸è¿‡è¿™ä¸ªå°±éœ€è¦è®¾ä¸€ä¸ªå…¨å±€çš„root</span>
        <span class="token comment" spellcheck="true"># img = cv2.imread(data['imagePath'], 0)</span>
        height<span class="token punctuation">,</span> width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        img <span class="token operator">=</span> None
        image<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">=</span> height
        image<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">=</span> width
        image<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true"># image['file_name'] = data['imagePath'].split("\\")[-1] #æ­¤è¡Œä¸é€‚åˆæˆ‘çš„æ•°æ®é›†</span>
        image<span class="token punctuation">[</span><span class="token string">'file_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'imagePath'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>height <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>width <span class="token operator">=</span> width

        <span class="token keyword">return</span> image

    <span class="token keyword">def</span> <span class="token function">categorie</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
        categorie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true"># categorie['supercategory'] = 'Cancer'  # è¿™ä¸ªæ— ç”¨</span>
        categorie<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment" spellcheck="true"># 0 é»˜è®¤ä¸ºèƒŒæ™¯</span>
        categorie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> label
        <span class="token keyword">return</span> categorie

    <span class="token keyword">def</span> <span class="token function">annotation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> points<span class="token punctuation">,</span> label<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        annotation <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        annotation<span class="token punctuation">[</span><span class="token string">'segmentation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>list<span class="token punctuation">(</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        annotation<span class="token punctuation">[</span><span class="token string">'iscrowd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        annotation<span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true"># annotation['bbox'] = str(self.getbbox(points)) # ä½¿ç”¨listä¿å­˜jsonæ–‡ä»¶æ—¶æŠ¥é”™ï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</span>
        <span class="token comment" spellcheck="true"># list(map(int,a[1:-1].split(','))) a=annotation['bbox'] ä½¿ç”¨è¯¥æ–¹å¼è½¬æˆlist</span>
        annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span>float<span class="token punctuation">,</span> self<span class="token punctuation">.</span>getbbox<span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation<span class="token punctuation">[</span><span class="token string">'area'</span><span class="token punctuation">]</span> <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> annotation<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># annotation['category_id'] = self.getcatid(label)</span>
        annotation<span class="token punctuation">[</span><span class="token string">'category_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>getcatid<span class="token punctuation">(</span>label<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æ³¨æ„ï¼Œæºä»£ç é»˜è®¤ä¸º1</span>
        annotation<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>annID
        <span class="token keyword">return</span> annotation

    <span class="token keyword">def</span> <span class="token function">getcatid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> categorie <span class="token keyword">in</span> self<span class="token punctuation">.</span>categories<span class="token punctuation">:</span>
            <span class="token keyword">if</span> label <span class="token operator">==</span> categorie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> categorie<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">getbbox</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># img = np.zeros([self.height,self.width],np.uint8)</span>
        <span class="token comment" spellcheck="true"># cv2.polylines(img, [np.asarray(points)], True, 1, lineType=cv2.LINE_AA)  # ç”»è¾¹ç•Œçº¿</span>
        <span class="token comment" spellcheck="true"># cv2.fillPoly(img, [np.asarray(points)], 1)  # ç”»å¤šè¾¹å½¢ å†…éƒ¨åƒç´ å€¼ä¸º1</span>
        polygons <span class="token operator">=</span> points

        mask <span class="token operator">=</span> self<span class="token punctuation">.</span>polygons_to_mask<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>height<span class="token punctuation">,</span> self<span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">,</span> polygons<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print(polygons)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>mask2box<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">mask2box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''ä»maskåç®—å‡ºå…¶è¾¹æ¡†
        maskï¼š[h,w]  0ã€1ç»„æˆçš„å›¾ç‰‡
        1å¯¹åº”å¯¹è±¡ï¼Œåªéœ€è®¡ç®—1å¯¹åº”çš„è¡Œåˆ—å·ï¼ˆå·¦ä¸Šè§’è¡Œåˆ—å·ï¼Œå³ä¸‹è§’è¡Œåˆ—å·ï¼Œå°±å¯ä»¥ç®—å‡ºå…¶è¾¹æ¡†ï¼‰
        '''</span>
        <span class="token comment" spellcheck="true"># np.where(mask==1)</span>
        index <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print(index)</span>

        rows <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        clos <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># è§£æå·¦ä¸Šè§’è¡Œåˆ—å·</span>
        <span class="token comment" spellcheck="true"># print(rows)</span>
        left_top_r <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>rows<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># y</span>
        left_top_c <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>clos<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># x</span>

        <span class="token comment" spellcheck="true"># è§£æå³ä¸‹è§’è¡Œåˆ—å·</span>
        right_bottom_r <span class="token operator">=</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
        right_bottom_c <span class="token operator">=</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>clos<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># return [(left_top_r,left_top_c),(right_bottom_r,right_bottom_c)]</span>
        <span class="token comment" spellcheck="true"># return [(left_top_c, left_top_r), (right_bottom_c, right_bottom_r)]</span>
        <span class="token comment" spellcheck="true"># return [left_top_c, left_top_r, right_bottom_c, right_bottom_r]  # [x1,y1,x2,y2]</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>left_top_c<span class="token punctuation">,</span> left_top_r<span class="token punctuation">,</span> right_bottom_c <span class="token operator">-</span> left_top_c<span class="token punctuation">,</span>
                right_bottom_r <span class="token operator">-</span> left_top_r<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># [x1,y1,w,h] å¯¹åº”COCOçš„bboxæ ¼å¼</span>

    <span class="token keyword">def</span> <span class="token function">polygons_to_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_shape<span class="token punctuation">,</span> polygons<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>img_shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        mask <span class="token operator">=</span> PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
        xy <span class="token operator">=</span> list<span class="token punctuation">(</span>map<span class="token punctuation">(</span>tuple<span class="token punctuation">,</span> polygons<span class="token punctuation">)</span><span class="token punctuation">)</span>
        PIL<span class="token punctuation">.</span>ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span>polygon<span class="token punctuation">(</span>xy<span class="token operator">=</span>xy<span class="token punctuation">,</span> outline<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        mask <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> dtype<span class="token operator">=</span>bool<span class="token punctuation">)</span>
        <span class="token keyword">return</span> mask

    <span class="token keyword">def</span> <span class="token function">data2coco</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_coco <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        data_coco<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>images
        data_coco<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>categories
        data_coco<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>annotations
        <span class="token keyword">return</span> data_coco

    <span class="token keyword">def</span> <span class="token function">save_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_transfer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data_coco <span class="token operator">=</span> self<span class="token punctuation">.</span>data2coco<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># ä¿å­˜jsonæ–‡ä»¶</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_coco<span class="token punctuation">,</span> open<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> cls<span class="token operator">=</span>MyEncoder<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># indent=4 æ›´åŠ ç¾è§‚æ˜¾ç¤º</span>


<span class="token comment" spellcheck="true"># labelme_json = glob.glob(</span>
<span class="token comment" spellcheck="true">#     '/home/lry/projects/mmdetection/data/780b/*.json')</span>
<span class="token comment" spellcheck="true"># print(labelme_json)</span>


<span class="token comment" spellcheck="true"># # labelme_json=['./Annotations/*.json']</span>
<span class="token comment" spellcheck="true"># # labelme_json=glob.glob('./Annotations/*.json')</span>

<span class="token comment" spellcheck="true"># saveme_json = '/home/lry/projects/mmdetection/lry/draft.json'</span>
<span class="token comment" spellcheck="true"># print("Start.")</span>

<span class="token comment" spellcheck="true"># labelme2coco(labelme_json, saveme_json)</span>
<span class="token comment" spellcheck="true"># print("Finished.")</span>


val_json <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'/home/lry/data/780b_std/val/*.json'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>val_json<span class="token punctuation">)</span>
saveme_json <span class="token operator">=</span> <span class="token string">'/home/lry/data/780b_std/val/annotation_coco.json'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Start."</span><span class="token punctuation">)</span>

labelme2coco<span class="token punctuation">(</span>val_json<span class="token punctuation">,</span> saveme_json<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finished."</span><span class="token punctuation">)</span>

train_json <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'/home/lry/data/780b_std/train/*.json'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_json<span class="token punctuation">)</span>
saveme_json <span class="token operator">=</span> <span class="token string">'/home/lry/data/780b_std/train/annotation_coco.json'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Start."</span><span class="token punctuation">)</span>

labelme2coco<span class="token punctuation">(</span>train_json<span class="token punctuation">,</span> saveme_json<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Finished."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†"><a href="#åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†" class="headerlink" title="åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†"></a>åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†</h2><p>è¿™é‡ŒæŒ‰ç…§7ï¼š3æ¥åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—ç”¨äºåˆ’åˆ†éªŒè¯é›†å’Œæµ‹è¯•é›†ï¼Œå¤§æ¦‚æ¯”ä¾‹ä¸º7ï¼š3"""</span>

<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> glob

<span class="token keyword">def</span> <span class="token function">move_file</span><span class="token punctuation">(</span>old_path<span class="token punctuation">,</span> imgs<span class="token punctuation">,</span>  new_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ç§»åŠ¨å›¾ç‰‡å’Œç›¸åº”çš„jsonæ–‡ä»¶'''</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>old_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>new_path<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># filelist = os.listdir(old_path) #åˆ—å‡ºè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶,listdirè¿”å›çš„æ–‡ä»¶åˆ—è¡¨æ˜¯ä¸åŒ…å«è·¯å¾„çš„ã€‚</span>
    filelist <span class="token operator">=</span> imgs
    <span class="token keyword">print</span><span class="token punctuation">(</span>filelist<span class="token punctuation">)</span>
    <span class="token keyword">for</span> file <span class="token keyword">in</span> filelist<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># file = file - "/home/lry/data/780b_std/"</span>
        src <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>old_path<span class="token punctuation">,</span> file<span class="token punctuation">[</span>len<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_std/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        dst <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_path<span class="token punctuation">,</span> file<span class="token punctuation">[</span>len<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_std/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        src_json <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>old_path<span class="token punctuation">,</span> file<span class="token punctuation">[</span>len<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_std/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span>
        dst_json <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_path<span class="token punctuation">,</span> file<span class="token punctuation">[</span>len<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_std/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'src:'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'dst:'</span><span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src_json<span class="token punctuation">,</span> dst_json<span class="token punctuation">)</span>


old_path <span class="token operator">=</span> <span class="token string">"/home/lry/data/780b_std"</span>

new_val <span class="token operator">=</span> <span class="token string">"/home/lry/data/780b_std/val"</span>
new_train <span class="token operator">=</span> <span class="token string">"/home/lry/data/780b_std/train"</span>

pics <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_std/*.json"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(len(pics))</span>
<span class="token comment" spellcheck="true"># print(pics[0][len("/home/lry/data/780b_std/"):-5] + ".jpg")</span>
<span class="token comment" spellcheck="true"># print(pics[0][:-4])</span>
<span class="token comment" spellcheck="true"># print(pics)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"moving...."</span><span class="token punctuation">)</span>
move_file<span class="token punctuation">(</span>old_path<span class="token punctuation">,</span> pics<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_train<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train end!"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"moving..."</span><span class="token punctuation">)</span>
move_file<span class="token punctuation">(</span>old_path<span class="token punctuation">,</span> pics<span class="token punctuation">[</span><span class="token number">140</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_val<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"val end!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="è®¾å®šconfigæ–‡ä»¶"><a href="#è®¾å®šconfigæ–‡ä»¶" class="headerlink" title="è®¾å®šconfigæ–‡ä»¶"></a>è®¾å®šconfigæ–‡ä»¶</h2><p>æˆ‘ä»¬å†³å®šç”¨mask_rcnnï¼Œè¿™é‡Œç›´æ¥åœ¨<code>configs</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å«åšfenghuoï¼Œç„¶ååŠ å…¥ä¸€ä¸ª<code>mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo.py</code>æ–‡ä»¶å°±OKã€‚æ–‡ä»¶å†…å®¹ä¸ºï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—ç”¨äºæ”¾ç½®configsï¼Œå®šä¹‰æ¨¡å‹ç»“æ„,
è¯¥é…ç½®æ–‡ä»¶å°†æ”¾åˆ°`/home/lry/projects/mmdetection/configs/fenghuo/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py`"""</span>

<span class="token comment" spellcheck="true"># The new config inherits a base config to highlight the necessary modification</span>
_base_ <span class="token operator">=</span> <span class="token string">'../mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py'</span>

<span class="token comment" spellcheck="true"># We also need to change the num_classes in head to match the dataset's annotation</span>
model <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    roi_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        bbox_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Modify dataset related settings</span>
dataset_type <span class="token operator">=</span> <span class="token string">'COCODataset'</span>
classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'780B'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> dict<span class="token punctuation">(</span>
    train<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/train/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/train/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    val<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/val/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        img_prefix<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/val/'</span><span class="token punctuation">,</span>
        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>
        ann_file<span class="token operator">=</span><span class="token string">'/home/lry/projects/mmdetection/data/780b_std/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># We can use the pre-trained Mask RCNN model to obtain higher performance</span>
load_from <span class="token operator">=</span> <span class="token string">'checkpoints/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="è®­ç»ƒæ¨¡å‹"><a href="#è®­ç»ƒæ¨¡å‹" class="headerlink" title="è®­ç»ƒæ¨¡å‹"></a>è®­ç»ƒæ¨¡å‹</h2><pre class="line-numbers language-python"><code class="language-python">python tools<span class="token operator">/</span>train<span class="token punctuation">.</span>py configs<span class="token operator">/</span>fenghuo<span class="token operator">/</span>mask_rcnn_r50_caffe_fpn_mstrain<span class="token operator">-</span>poly_1x_fenghuo<span class="token punctuation">.</span>py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="æµ‹è¯•æ¨¡å‹"><a href="#æµ‹è¯•æ¨¡å‹" class="headerlink" title="æµ‹è¯•æ¨¡å‹"></a>æµ‹è¯•æ¨¡å‹</h2><pre class="line-numbers language-python"><code class="language-python">CUDA_VISIBLE<span class="token operator">=</span><span class="token number">1</span> python tools<span class="token operator">/</span>test<span class="token punctuation">.</span>py configs<span class="token operator">/</span>fenghuo<span class="token operator">/</span>mask_rcnn_r50_caffe_fpn_mstrain<span class="token operator">-</span>poly_1x_fenghuo<span class="token punctuation">.</span>py work_dirs<span class="token operator">/</span>mask_rcnn_r50_caffe_fpn_mstrain<span class="token operator">-</span>poly_1x_fenghuo<span class="token operator">/</span>latest<span class="token punctuation">.</span>pth  <span class="token operator">-</span><span class="token operator">-</span>eval bbox segm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="2021-11-14æ—¥æ—©æ›´æ–°"><a href="#2021-11-14æ—¥æ—©æ›´æ–°" class="headerlink" title="2021.11.14æ—¥æ—©æ›´æ–°"></a>2021.11.14æ—¥æ—©æ›´æ–°</h1><ul>
<li>è¿œç¨‹ä»“åº“ï¼š<a href="https://www.jianshu.com/p/e4bb2ac7e770" target="_blank" rel="noopener">https://www.jianshu.com/p/e4bb2ac7e770</a></li>
</ul>
<p>ç›®å‰éœ€è¦æ–°å»ºè¿œç¨‹GitHubä»“åº“æ–¹ä¾¿æˆ‘ä¸åˆ«äººåä½œ</p>
<p>ç›®å‰æ•´ä¸ªå¤§æ¡†çš„æ£€æµ‹è¿˜æ¯”è¾ƒæˆåŠŸï¼Œæ¥ç€å°±æ˜¯æ£€æµ‹æ¯ä¸ªå°æ¡†çš„åˆ†ç±»ä»»åŠ¡ã€‚</p>
<h1 id="2021-11-29æ—¥æ™šæ›´æ–°"><a href="#2021-11-29æ—¥æ™šæ›´æ–°" class="headerlink" title="2021.11.29æ—¥æ™šæ›´æ–°"></a>2021.11.29æ—¥æ™šæ›´æ–°</h1><p>è¿œç¨‹ä»“åº“åˆ›å»ºæˆåŠŸï¼Œä»“åº“åœ°å€ï¼š<a href="https://github.com/LRY89757/mmdet-for-fenghuo" target="_blank" rel="noopener">çƒ½ç«æ£€æµ‹</a></p>
<p>ç›®å‰éœ€è¦åšçš„äº‹æƒ…ï¼š</p>
<ul>
<li>å†™ä¸€ä¸ªå…³äºè¿™ç±»Labelmeæ–‡æ¡£éœ€è¦çš„dataloaderï¼Œå†™ä¸€ä¸ªå°½é‡æ¯”è¾ƒå…¨é¢é€‚é…æ€§æ¯”è¾ƒå¼ºã€å¯è¿ç§»æ€§æ¯”è¾ƒå¥½çš„dataloader</li>
<li>å¯¹äºè¿è¡Œå‡ºæ¥çš„ç»“æœçš„å›¾åƒåšä¸€ä¸ªç®€å•çš„åˆ‡åˆ†ï¼Œå¹³å‡åˆ†ä¸º19ä»½ç„¶åå°†æ¯ä¸€ä¸ªå•ç‹¬çš„ç›˜éƒ½cropå‡ºæ¥ç„¶åå°†éç›˜åŒºåŸŸæ ‡é»‘æ”¾åˆ°resnet101ç­‰å„ç±»åˆ†ç±»ç½‘ç»œä¸­è¿›è¡Œç›¸å…³çš„åˆ†ç±»ä»»åŠ¡ã€‚</li>
<li>åˆ’åˆ†æµ‹è¯•é›†å’Œè®­ç»ƒé›†çš„æ—¶å€™é€‰æ‹©ä½¿ç”¨ç”Ÿæˆval.txtè¿˜æœ‰train.txtæ–‡ä»¶çš„æ ¼å¼ï¼Œæ¯ä¸ª.txtæ–‡ä»¶å†…é˜²æ­¢ç›¸å…³æ•°æ®çš„è·¯å¾„ã€‚è€Œä¸æ˜¯å°†å…¶å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ä¸­è¿›è¡Œåˆ†ç±»ï¼Œä¸‡ä¸€ç¡¬ç›˜æ²¡æœ‰é‚£ä¹ˆå¤§çš„ç©ºé—´æ€ä¹ˆåŠï¼Œä¸è¦æ»¥ç”¨ç¡¬ç›˜èµ„æºã€‚</li>
</ul>
<h1 id="2021-11-30æ—¥æ™šæ›´æ–°"><a href="#2021-11-30æ—¥æ™šæ›´æ–°" class="headerlink" title="2021.11.30æ—¥æ™šæ›´æ–°"></a>2021.11.30æ—¥æ™šæ›´æ–°</h1><p>ç›®å‰å·²ç»ç¡®å®šæœ¬å‘¨ç°åšç¬¬äºŒé¡¹ï¼Œå°±æ˜¯åšä¸€ä¸‹ç›®å‰ç›˜ç¬¦çš„åˆ†ç±»æ“ä½œã€‚</p>
<p>ç›®å‰ç¬¬ä¸€æ­¥é‡åˆ°çš„å›°éš¾å°±æ˜¯æš‚æ—¶ä¸çŸ¥é“æˆ‘ä»¬<code>inference_detector()</code>è¿™ä¸ªå‡½æ•°å¾—åˆ°çš„ç»“æœçš„å¤§è‡´å½¢å¼ã€‚å› ä¸ºä¹‹å‰åšåˆ†å‰²çš„æ—¶å€™ç›´æ¥å°†ç»“æœæ”¾åˆ°å‡½æ•°çš„å‚æ•°ä¸­<code>model.show_result(img, result, out_file=f&#39;/home/lry/projects/mmdetection/lry/demo{i}.jpg&#39;)</code>æ¥æ˜¾ç¤ºç»“æœäº†ï¼Œå†åŠ ä¸Šæˆ‘æœ¬æ¥å¯¹è¿™ä¸ªä¹Ÿä¸å¤ªç†Ÿæ‚‰ï¼Œæ‰€ä»¥ç›®å‰æ‰“ç®—æ·±å…¥ç†è§£ä¸‹å…³äºå‡½æ•°<code>inference_detector()</code>ï¼Œé¡ºä¾¿å°†è¿™ä¸€ç³»åˆ—æœ‰å…³çš„éƒ½äº†è§£ä¸€ä¸‹ï¼š<code>init_detector,inference_detector, show_result_pyplot</code>,è¿™äº›éƒ½æ˜¯æºäºåº“<code>mmdet.apis</code>,æ‰€ä»¥æˆ‘ä»¬æ¥æ‰¾ä¸€ä¸‹<a href="https://mmdetection.readthedocs.io/en/latest/api.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>å…³äºmmdet.apisçš„æœ‰å…³è§£é‡Šï¼š<br>å®é™…ä¸Šæœ‰å…³<code>inference_detector</code>çš„<a href="https://mmdetection.readthedocs.io/en/latest/api.html#mmdet.apis.inference_detector" target="_blank" rel="noopener">å†…å®¹</a>ååˆ†æœ‰é™ï¼š</p>
<blockquote>
<p>mmdet.apis.inference_detector(<em>model</em>, <em>imgs</em>)<a href="https://mmdetection.readthedocs.io/en/latest/_modules/mmdet/apis/inference.html#inference_detector" target="_blank" rel="noopener">[SOURCE]</a></p>
<p>Inference image(s) with the detector.</p>
<ul>
<li><p>Parameters</p>
<p><strong>model</strong> (<em>nn.Module</em>) â€“ The loaded detector.<strong>imgs</strong> (<em>str/ndarray</em> <em>or</em> <em>list<strong>[</strong>str/ndarray**] or</em> <em>tuple<strong>[</strong>str/ndarray**]</em>) â€“ Either image files or loaded images.</p>
</li>
<li><p>Returns</p>
<p>If imgs is a list or tuple, the same length list type results will be returned, otherwise return the detection results directly.</p>
</li>
</ul>
</blockquote>
<p>å½“ç„¶æ„Ÿå…´è¶£å¯ä»¥å»é€‰æ‹©çœ‹ä¸€ä¸‹æœ‰å…³æºç .è¿™é‡Œæˆ‘é€‰æ‹©ç”¨ä»£ç æ¥æ¢ç´¢ä¸‹æœ‰å…³çš„ç»“æœ:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>apis <span class="token keyword">import</span> init_detector<span class="token punctuation">,</span>inference_detector<span class="token punctuation">,</span> show_result_pyplot
<span class="token keyword">import</span> mmcv
<span class="token keyword">import</span> os
<span class="token keyword">import</span> glob
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor

config_file <span class="token operator">=</span> <span class="token string">"/home/lry/projects/mmdetection/configs/fenghuo/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo.py"</span>
checkpoint_file <span class="token operator">=</span> <span class="token string">"/home/lry/projects/mmdetection/work_dirs/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo/latest.pth"</span>
model <span class="token operator">=</span> init_detector<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint_file<span class="token punctuation">,</span>device<span class="token operator">=</span><span class="token string">"cuda:3"</span><span class="token punctuation">)</span>

img <span class="token operator">=</span> <span class="token string">'/home/lry/projects/mmdetection/data/780b_std/IMG_20211021_153945.jpg'</span>
result <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">'\n\n'</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\n\n'</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
img <span class="token operator">=</span> Image<span class="token punctuation">.</span>open<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰å…³è¿™éƒ¨åˆ†ä¸»è¦å°±çœ‹resultçš„è¾“å‡ºåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿,å¦‚æœæˆ‘ä»¬æƒ³è¦ä¿å­˜ç»“æœåˆ°æŸåœ°æˆ–æ˜¯å±•ç¤ºç»“æœå¯ä»¥ç”¨<code>model.show_result(img, result, out_file=f&#39;/home/lry/projects/mmdetection/lry/demo{i}.jpg&#39;)</code>æ¥æ˜¾ç¤º.</p>
<p>ç®€å•æ¥çœ‹ä¸‹ä»£ç è¿è¡Œç»“æœ:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">(</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3.6979218e+02</span><span class="token punctuation">,</span> <span class="token number">2.3255410e+03</span><span class="token punctuation">,</span> <span class="token number">2.7979324e+03</span><span class="token punctuation">,</span> <span class="token number">4.2280156e+03</span><span class="token punctuation">,</span>
        <span class="token number">9.9831665e-01</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

 <span class="token punctuation">[</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3.6979218e+02</span><span class="token punctuation">,</span> <span class="token number">2.3255410e+03</span><span class="token punctuation">,</span> <span class="token number">2.7979324e+03</span><span class="token punctuation">,</span> <span class="token number">4.2280156e+03</span><span class="token punctuation">,</span>
        <span class="token number">9.9831665e-01</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token punctuation">]</span> 

 <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3.6979218e+02</span> <span class="token number">2.3255410e+03</span> <span class="token number">2.7979324e+03</span> <span class="token number">4.2280156e+03</span> <span class="token number">9.9831665e-01</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">4608</span><span class="token punctuation">,</span> <span class="token number">3456</span><span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4608</span><span class="token punctuation">,</span> <span class="token number">3456</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°,resultæ˜¯ä¸€ä¸ªå…ƒç»„,å…ƒç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªnp.array,å«æœ‰5ä¸ªå…ƒç´ ,5ä¸ªå…ƒç´ ä¸­ç¬¬ä¸€ä¸ªä»£è¡¨çš„æ˜¯æ£€æµ‹æ¡†çš„å‡†ç¡®åº¦,ç„¶åå››ä¸ªå‚æ•°ä»£è¡¨çš„æ˜¯å›¾ç‰‡çš„æ£€æµ‹æ¡†çš„å·¦ä¸Šå³ä¸‹ç›¸å…³å‚æ•°,ç„¶åç¬¬äºŒä¸ªå…ƒç´ å°±æ˜¯å›¾ç‰‡åˆ†å‰²æ•°æ®é›†çš„åˆ†å‰²ç»“æœäº†.è¿™ä¸ªç»“æœæ˜¯ç”±Trueå’ŒFalseç»„æˆçš„å’Œå›¾åƒæœ¬èº«Tensorå¤§å°ç›¸åŒçš„ä¸€ä¸ªçŸ©é˜µ.(Trueä»£è¡¨è¯¥åƒç´ æ˜¯å«æœ‰ç‰©ä½“çš„)</p>
<h2 id="Code-Trace-of-mmdet-apis-inference-detector"><a href="#Code-Trace-of-mmdet-apis-inference-detector" class="headerlink" title="Code Trace of mmdet.apis.inference_detector()"></a>Code Trace of <code>mmdet.apis.inference_detector()</code></h2><p>çš„ç¡®åˆšæ‰æˆ‘ä»¬å°†è¿™ä¸ªæ¥å£å½“ä½œé»‘ç›’æ¥æ¢ç´¢åˆ°äº†ä»–çš„ä¸€äº›å…·ä½“åŠŸèƒ½ã€‚è¿™æ ·å¯¹äºåšé¡¹ç›®æ¥è¯´éå¸¸è¶³å¤Ÿäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œæ·±å…¥ä¸€ä¸‹æ¥æ¢ç´¢ä¸€ä¸‹ä»–çš„æºç æ˜¯æ€ä¹ˆæ ·çš„ï¼ˆ<del>æ„Ÿè°¢è’‹å“¥å¸¦æˆ‘é£</del>ï¼‰ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹æˆ‘ä»¬çš„inference_detector()æºç <code>mmdet/apis/inference.py</code>:</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">inference_detector</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Inference image(s) with the detector.

    Args:
        model (nn.Module): The loaded detector.
        imgs (str/ndarray or list[str/ndarray] or tuple[str/ndarray]):
           Either image files or loaded images.

    Returns:
        If imgs is a list or tuple, the same length list type results
        will be returned, otherwise return the detection results directly.
    """</span>

    <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token punctuation">(</span>list<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        is_batch <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        imgs <span class="token operator">=</span> <span class="token punctuation">[</span>imgs<span class="token punctuation">]</span>
        is_batch <span class="token operator">=</span> <span class="token boolean">False</span>

    cfg <span class="token operator">=</span> model<span class="token punctuation">.</span>cfg
    device <span class="token operator">=</span> next<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>device  <span class="token comment" spellcheck="true"># model device</span>

    <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>imgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cfg <span class="token operator">=</span> cfg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># set loading pipeline type</span>
        cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>test<span class="token punctuation">.</span>pipeline<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'LoadImageFromWebcam'</span>

    cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>test<span class="token punctuation">.</span>pipeline <span class="token operator">=</span> replace_ImageToTensor<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>test<span class="token punctuation">.</span>pipeline<span class="token punctuation">)</span>
    test_pipeline <span class="token operator">=</span> Compose<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>test<span class="token punctuation">.</span>pipeline<span class="token punctuation">)</span>

    datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> img <span class="token keyword">in</span> imgs<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># prepare data</span>
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>img<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># directly add img</span>
            data <span class="token operator">=</span> dict<span class="token punctuation">(</span>img<span class="token operator">=</span>img<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># add information into dict</span>
            data <span class="token operator">=</span> dict<span class="token punctuation">(</span>img_info<span class="token operator">=</span>dict<span class="token punctuation">(</span>filename<span class="token operator">=</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> img_prefix<span class="token operator">=</span>None<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># build the data pipeline</span>
        data <span class="token operator">=</span> test_pipeline<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        datas<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    data <span class="token operator">=</span> collate<span class="token punctuation">(</span>datas<span class="token punctuation">,</span> samples_per_gpu<span class="token operator">=</span>len<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># just get the actual data from DataContainer</span>
    data<span class="token punctuation">[</span><span class="token string">'img_metas'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>img_metas<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> img_metas <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'img_metas'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    data<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>img<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> img <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> next<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_cuda<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># scatter to specified GPU</span>
        data <span class="token operator">=</span> scatter<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">[</span>device<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> model<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> <span class="token operator">not</span> isinstance<span class="token punctuation">(</span>
                m<span class="token punctuation">,</span> RoIPool
            <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'CPU inference with RoIPool is not supported currently.'</span>

    <span class="token comment" spellcheck="true"># forward the model</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        results <span class="token operator">=</span> model<span class="token punctuation">(</span>return_loss<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> rescale<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>data<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token operator">not</span> is_batch<span class="token punctuation">:</span>
        <span class="token keyword">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> results<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®é™…ä¸Šè¿™ä¹ˆé•¿çš„æºç ï¼ŒçœŸæ­£å…³é”®çš„å°±å€’æ•°ç¬¬å…­è¡Œçš„ä»£ç <code>results = model(return_loss=False, rescale=True, **data)</code>è¿™è¡Œä»£ç è°ƒç”¨äº†modelæ¥è¿›è¡Œæ¨ç†ç„¶åè¿”å›äº†ç»“æœresultsã€‚æˆ‘ä»¬è¦çœ‹modelçš„è€Œmodelæ˜¯æˆ‘ä»¬ä¼ è¿›æ¥çš„å‚æ•°ï¼Œæ˜¯æˆ‘ä»¬ä½¿ç”¨<code>init_detector</code>è¿™ä¸ªæ¥å£æ¥è°ƒç”¨çš„ï¼Œè¿™ä¸ªæ¥å£ä½¿ç”¨äº†æˆ‘ä»¬çš„configæ–‡ä»¶ä»¥åŠç›¸å…³çš„checkpointæ–‡ä»¶ã€‚è¿™é‡Œconfigæ–‡ä»¶å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ­å»ºçš„æ¨¡å‹ã€‚æˆ‘ä»¬éœ€è¦çœ‹çš„æ˜¯å…³äºconfigæ–‡ä»¶é‡Œé¢æ‰€ç”¨çš„æ¨¡å‹ã€‚è€Œè¦æœ€åçš„è¾“å‡ºæ˜¯ç”±<code>roi_heads</code>ï¼Œä¹Ÿå°±æ˜¯maskrcnnæœ€åä¸€ä¸ªæ¨¡å—æ¥è¾“å‡ºçš„ã€‚æˆ‘ä»¬å…ˆè¿½è¸ªä¸€ä¸‹æœ‰å…³çš„configæ–‡ä»¶ï¼š<br>é¦–å…ˆæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸Šå±‚çš„configæ–‡ä»¶<code>configs/fenghuo/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo.py</code>, ä»è¿™é‡Œæ‰¾å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç»§æ‰¿çš„æ˜¯<code>_base_ = &#39;../mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py&#39;</code>é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­æ‰¾åˆ°è¿™ä¸ªæ¨¡å—å°±<code>configs/mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py</code>,å¯ä»¥çœ‹åˆ°ä»–ç»§æ‰¿çš„æ˜¯<code>_base_ = &#39;./mask_rcnn_r50_fpn_1x_coco.py&#39;</code>,æˆ‘ä»¬ç»§ç»­æ‰¾è¿™ä¸ªæ–‡ä»¶<code>configs/mask_rcnn/mask_rcnn_r50_fpn_1x_coco.py</code>,è¿™ä¸ªæ–‡ä»¶æœ‰ç‚¹åƒæ˜¯ä¸€ä¸ªpackageçš„<code>__init__.py</code>ï¼Œå°±æ˜¯ä»£ç åªæœ‰æ‰€æœ‰éœ€è¦ç»§æ‰¿çš„åŸºæœ¬ç±»å‹ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">_base_ <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'../_base_/models/mask_rcnn_r50_fpn.py'</span><span class="token punctuation">,</span>
    <span class="token string">'../_base_/datasets/coco_instance.py'</span><span class="token punctuation">,</span>
    <span class="token string">'../_base_/schedules/schedule_1x.py'</span><span class="token punctuation">,</span> <span class="token string">'../_base_/default_runtime.py'</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œå°±æ˜¯ä¸€äº›æ¨¡å‹å…·ä½“é…ç½®çš„ç»§æ‰¿åŸºç±»æ–‡ä»¶ï¼Œæˆ‘ä»¬æƒ³è¦çœ‹æ¨¡å‹çš„<code>roi_heads</code>éƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å»æ‰¾<code>&#39;../_base_/models/mask_rcnn_r50_fpn.py&#39;</code>æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<code>configs/_base_/models/mask_rcnn_r50_fpn.py</code>é‡Œæ‰¾åˆ°<code>roi_heads</code>çš„å®šä¹‰:</p>
<pre class="line-numbers language-python"><code class="language-python">    roi_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        type<span class="token operator">=</span><span class="token string">'StandardRoIHead'</span><span class="token punctuation">,</span>
        bbox_roi_extractor<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bbox_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>
            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            fc_out_channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
            roi_feat_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
            bbox_coder<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>
                target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            reg_class_agnostic<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            loss_cls<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            loss_bbox<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_roi_extractor<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span> output_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            type<span class="token operator">=</span><span class="token string">'FCNMaskHead'</span><span class="token punctuation">,</span>
            num_convs<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            conv_out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
            loss_mask<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œé¢å¯ä»¥çœ‹åˆ°æ•´ä¸ª<code>roi_head</code>éƒ½æ˜¯å±äº<code>type=&#39;StandardRoIHead&#39;</code>, ç”±äºMMDetectionçš„æ³¨å†Œå™¨Registryæœºåˆ¶ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦å»åˆ°<code>mmdet</code>æ–‡ä»¶å¤¹ä¸­å»æ‰¾è¿™äº›ä¸œè¥¿ï¼Œåœ¨<code>mmdet/models/roi_heads</code>ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°<code>mmdet/models/roi_heads/standard_roi_head.py</code>è¿™ä¸ªæ–‡ä»¶ã€‚<br>ç„¶åæˆ‘ä»¬éœ€è¦ä»ç±»ä¸­å¯»æ‰¾å…³äºforwardçš„æœ‰å…³å‡½æ•°ï¼Œåˆšå¼€å§‹æ‰¾çš„æ˜¯<code>forward_dummy()</code>è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ä»è¿™ä¸ªå‡½æ•°ä¸­çœ‹ä¸åˆ°å…³äºcls_scoreå’Œbbox_predä»¥åŠmask_predçš„åˆå¹¶æœ‰å…³æ­¥éª¤ï¼Œæˆ–è€…è¯´ä¸å¤ªèƒ½å¯¹åº”ä¸Šï¼Œåæ¥æ‰“äº†ä¸€äº›æ–­ç‚¹å‘ç°ä¼¼ä¹ç¨‹åºæ ¹æœ¬ä¸ä¼šç»è¿‡è¿™ä¸ªå‡½æ•°ã€‚æ‰€ä»¥åº”è¯¥ä¸æ˜¯ç»è¿‡è¿™ä¸ªforwardå‡½æ•°ï¼Œè€Œå¦å¤–çš„forwardå‡½æ•°ï¼Œé¦–å…ˆå¯ä»¥æ’é™¤<code>forward_train</code>è¿™ä¸ªå‡½æ•°ï¼Œæˆ–è€…æ˜¯æ’é™¤æ‰€æœ‰å’Œtrainæœ‰å…³çš„å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ¯•ç«Ÿè¿™ä¸ªæ˜¯åšçš„æ¨æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„ä¸æ˜¯å»trainï¼Œè‡³å°‘ä¹Ÿåœ¨testé‡Œé¢ã€‚</p>
<p>åæ¥ç»è¿‡æ‰“æ–­ç‚¹å‘ç°ç¨‹åºè¿è¡Œåœ¨<code>simple_test()</code>è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">simple_test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                    x<span class="token punctuation">,</span>
                    proposal_list<span class="token punctuation">,</span>
                    img_metas<span class="token punctuation">,</span>
                    proposals<span class="token operator">=</span>None<span class="token punctuation">,</span>
                    rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Test without augmentation.

        Args:
            x (tuple[Tensor]): Features from upstream network. Each
                has shape (batch_size, c, h, w).
            proposal_list (list(Tensor)): Proposals from rpn head.
                Each has shape (num_proposals, 5), last dimension
                5 represent (x1, y1, x2, y2, score).
            img_metas (list[dict]): Meta information of images.
            rescale (bool): Whether to rescale the results to
                the original image. Default: True.

        Returns:
            list[list[np.ndarray]] or list[tuple]: When no mask branch,
            it is bbox results of each image and classes with type
            `list[list[np.ndarray]]`. The outer list
            corresponds to each image. The inner list
            corresponds to each class. When the model has mask branch,
            it contains bbox results and mask results.
            The outer list corresponds to each image, and first element
            of tuple is bbox results, second element is mask results.
        """</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>with_bbox<span class="token punctuation">,</span> <span class="token string">'Bbox head must be implemented.'</span>

        det_bboxes<span class="token punctuation">,</span> det_labels <span class="token operator">=</span> self<span class="token punctuation">.</span>simple_test_bboxes<span class="token punctuation">(</span>
            x<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> proposal_list<span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_cfg<span class="token punctuation">,</span> rescale<span class="token operator">=</span>rescale<span class="token punctuation">)</span>

        bbox_results <span class="token operator">=</span> <span class="token punctuation">[</span>
            bbox2result<span class="token punctuation">(</span>det_bboxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> det_labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        self<span class="token punctuation">.</span>bbox_head<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>det_bboxes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>with_mask<span class="token punctuation">:</span>
            <span class="token keyword">return</span> bbox_results
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            segm_results <span class="token operator">=</span> self<span class="token punctuation">.</span>simple_test_mask<span class="token punctuation">(</span>
                x<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> det_bboxes<span class="token punctuation">,</span> det_labels<span class="token punctuation">,</span> rescale<span class="token operator">=</span>rescale<span class="token punctuation">)</span>
            <span class="token keyword">return</span> list<span class="token punctuation">(</span>zip<span class="token punctuation">(</span>bbox_results<span class="token punctuation">,</span> segm_results<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ç€è°ƒè¯•å‘ç°è¿™é‡Œè°ƒç”¨äº†å‡½æ•°bbox2result()æ¥å®ç°äº†å…³äºè½¬åŒ–çš„ä¸€äº›é—®é¢˜ã€‚</p>
<p>å®é™…ä¸Šåˆ°æ­¤å°±ç»“æŸäº†ï¼Œå½“ç„¶<code>forward_dummy()</code>è¿™ä¸ªå‡½æ•°æ˜¯éå¸¸æœ‰ç ”ç©¶æ„ä¹‰çš„ï¼Œåœ¨<code>mmdet/models/detectors/two_stage.py</code>é‡Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ˜¯ä¸ºäº†ï¼Œç‰¹åˆ«æ˜¯è¿™é‡Œè°ƒç”¨äº†<code>_bbox_forward()</code>è¿™ä¸ªå‡½æ•°,å€¼å¾—æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬ä»¥ä¸Šä»…ä»…æ˜¯è®²äº†ä¸€ä¸ªmask_rcnnçš„ä¸€ä¸ªå¾ˆå°çš„<code>roi_head</code>éƒ¨åˆ†ï¼Œå¦‚æœè¦æ€»ä½“çœ‹å…¨ä½“çš„ä¸€ä¸ªæ¦‚å†µçš„è¯ï¼Œå¯ä»¥é€‰æ‹©å»çœ‹ä¸€ä¸‹<code>mmdet/models/detectors/two_stage.py</code>è™½ç„¶ä¹Ÿä¸ç®—æ˜¯æ€»ä½“ï¼Œä½†æ˜¯ä¹Ÿé«˜äº†ä¸€çº§ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“çš„è¿™ä¸ª<code>TwoStageDetector</code>æ˜¯æ€ä¹ˆè°ƒåº¦çš„ï¼Œæ˜¯å¦‚ä½•è¿è¡Œèµ·æ¥çš„ã€‚</p>
<h2 id="dataloader-in-mmdetection"><a href="#dataloader-in-mmdetection" class="headerlink" title="dataloader in mmdetection"></a><strong>dataloader in mmdetection</strong></h2><p>å…¶æ¬¡æ˜¯å…³äºè¿™å‘¨è¦åšçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡å®é™…ä¸Šå°±æ˜¯æ¥åšä¸€ä¸ªLabelmeæ•°æ®çš„dataloader,å½“ç„¶è¯´èµ·æ¥å®¹æ˜“ï¼Œè¿™ä¸ªè¦æŠŠdataloaderèåˆ°MMDetectioné‡Œé¢è¿˜æ˜¯éœ€è¦æ·±å…¥ç†è§£ä»–çš„Rigistryæœºåˆ¶çš„ï¼Œè€Œä¸”å…‰å†™ä»£ç è¿™ä¸€æ­¥å¦‚æœå®Œå…¨ä¸çœ‹ä»–çš„å…³äºCOCODatasetçš„ä»£ç é è‡ªå·±å†™ææ€•æ˜¯éå¸¸éš¾åŠçš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸€æ­¥ä¸€æ­¥çš„æ¥æ¢ç´¢ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥æ‰¾åˆ°COCOçš„dataloaderåˆ°åº•åœ¨å“ªé‡Œã€‚</p>
<p>è¿˜æ˜¯ä»configæ–‡ä»¶å¼€å§‹æ‰¾ï¼Œç”±äºä¸Šæ–‡å·²ç»æ‰¾è¿‡äº†ï¼Œè¿™é‡Œç›´æ¥å¼•ç”¨ä¸Šæ–‡çš„å¯»æ‰¾è¿‡ç¨‹ï¼š</p>
<p>â€œâ€â€â€</p>
<p>é¦–å…ˆæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸Šå±‚çš„configæ–‡ä»¶<code>configs/fenghuo/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo.py</code>, ä»è¿™é‡Œæ‰¾å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç»§æ‰¿çš„æ˜¯<code>_base_ = &#39;../mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py&#39;</code>é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­æ‰¾åˆ°è¿™ä¸ªæ¨¡å—å°±<code>configs/mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py</code>,å¯ä»¥çœ‹åˆ°ä»–ç»§æ‰¿çš„æ˜¯<code>_base_ = &#39;./mask_rcnn_r50_fpn_1x_coco.py&#39;</code>,æˆ‘ä»¬ç»§ç»­æ‰¾è¿™ä¸ªæ–‡ä»¶<code>configs/mask_rcnn/mask_rcnn_r50_fpn_1x_coco.py</code>,è¿™ä¸ªæ–‡ä»¶æœ‰ç‚¹åƒæ˜¯ä¸€ä¸ªpackageçš„<code>__init__.py</code>ï¼Œå°±æ˜¯ä»£ç åªæœ‰æ‰€æœ‰éœ€è¦ç»§æ‰¿çš„åŸºæœ¬ç±»å‹ï¼š</p>
<p>```python</p>
<p><em>base</em> = [</p>
<p>  â€˜../<em>base</em>/models/mask_rcnn_r50_fpn.pyâ€™,</p>
<p>  â€˜../<em>base</em>/datasets/coco_instance.pyâ€™,</p>
<p>  â€˜../<em>base</em>/schedules/schedule_1x.pyâ€™, â€˜../<em>base</em>/default_runtime.pyâ€™</p>
<p>]</p>
<p>```</p>
<p>â€œâ€â€</p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨<code>&#39;../_base_/datasets/coco_instance.py&#39;</code>é‡Œé¢ï¼Œå‰å‡ è¡Œä»£ç å°±æœ‰<code>dataset_type = &#39;CocoDataset&#39;</code>å’Œä¸Šæ–‡ç›¸åŒçš„Registryæœºåˆ¶ï¼Œæˆ‘ä»¬åˆ°<code>mmdet</code>æ–‡ä»¶å¤¹ä¸­å»å¯»æ‰¾ï¼Œå¯ä»¥å‘ç°åœ¨<code>mmdet/datasets/coco.py</code>é‡Œé¢æœ‰<code>CocoDataset</code>è¿™ä¸ªç±»ã€‚è¿™ä¸ªå°±æ˜¯å…³äºCocoDatasetçš„dataloader.ç»ˆäºæ‰¾åˆ°äº†ï¼</p>
<p>ä½†æ˜¯æœ‰574è¡Œä»£ç â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦èšŒåŸ ä½äº†ğŸ˜¥ã€‚</p>
<h1 id="2021-12-1æ—¥ä¸Šåˆæ›´æ–°"><a href="#2021-12-1æ—¥ä¸Šåˆæ›´æ–°" class="headerlink" title="2021.12.1æ—¥ä¸Šåˆæ›´æ–°"></a>2021.12.1æ—¥ä¸Šåˆæ›´æ–°</h1><h2 id="dataloader-in-mmdet"><a href="#dataloader-in-mmdet" class="headerlink" title="dataloader in mmdet"></a>dataloader in mmdet</h2><p>å†ç¨å¾®è¯´ä¸€ä¸‹å…³äºRigistryè¿˜æœ‰ç»§æ‰¿ç±»éœ€è¦åšçš„ä¸€äº›ä¸œè¥¿ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­ä»ä¸Šæ–‡ä¸­å¾—åˆ°çš„åœ¨<code>mmdet/datasets/coco.py</code>ä¸­çœ‹åˆ°çš„CocoDatasetç±»çš„å†…å®¹ï¼ˆä»…ä»…é€‰æ‹©äº†ä¸€éƒ¨åˆ†ï¼Œå®Œæ•´ç‰ˆçœ‹<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼‰ï¼š</p>
<p>```python</p>
<p># Copyright (c) OpenMMLab. All rights reserved.</p>
<p>@DATASETS.register_module()</p>
<p>class CocoDataset(CustomDataset):</p>
<p>  CLASSES = (â€˜personâ€™, â€˜bicycleâ€™, â€˜carâ€™, â€˜motorcycleâ€™, â€˜airplaneâ€™, â€˜busâ€™,</p>
<p>â€‹        â€˜trainâ€™, â€˜truckâ€™, â€˜boatâ€™, â€˜traffic lightâ€™, â€˜fire hydrantâ€™,</p>
<p>â€‹        â€˜stop signâ€™, â€˜parking meterâ€™, â€˜benchâ€™, â€˜birdâ€™, â€˜catâ€™, â€˜dogâ€™,</p>
<p>â€‹        â€˜horseâ€™, â€˜sheepâ€™, â€˜cowâ€™, â€˜elephantâ€™, â€˜bearâ€™, â€˜zebraâ€™, â€˜giraffeâ€™,</p>
<p>â€‹        â€˜backpackâ€™, â€˜umbrellaâ€™, â€˜handbagâ€™, â€˜tieâ€™, â€˜suitcaseâ€™, â€˜frisbeeâ€™,</p>
<p>â€‹        â€˜skisâ€™, â€˜snowboardâ€™, â€˜sports ballâ€™, â€˜kiteâ€™, â€˜baseball batâ€™,</p>
<p>â€‹        â€˜baseball gloveâ€™, â€˜skateboardâ€™, â€˜surfboardâ€™, â€˜tennis racketâ€™,</p>
<p>â€‹        â€˜bottleâ€™, â€˜wine glassâ€™, â€˜cupâ€™, â€˜forkâ€™, â€˜knifeâ€™, â€˜spoonâ€™, â€˜bowlâ€™,</p>
<p>â€‹        â€˜bananaâ€™, â€˜appleâ€™, â€˜sandwichâ€™, â€˜orangeâ€™, â€˜broccoliâ€™, â€˜carrotâ€™,</p>
<p>â€‹        â€˜hot dogâ€™, â€˜pizzaâ€™, â€˜donutâ€™, â€˜cakeâ€™, â€˜chairâ€™, â€˜couchâ€™,</p>
<p>â€‹        â€˜potted plantâ€™, â€˜bedâ€™, â€˜dining tableâ€™, â€˜toiletâ€™, â€˜tvâ€™, â€˜laptopâ€™,</p>
<p>â€‹        â€˜mouseâ€™, â€˜remoteâ€™, â€˜keyboardâ€™, â€˜cell phoneâ€™, â€˜microwaveâ€™,</p>
<p>â€‹        â€˜ovenâ€™, â€˜toasterâ€™, â€˜sinkâ€™, â€˜refrigeratorâ€™, â€˜bookâ€™, â€˜clockâ€™,</p>
<p>â€‹        â€˜vaseâ€™, â€˜scissorsâ€™, â€˜teddy bearâ€™, â€˜hair drierâ€™, â€˜toothbrushâ€™)</p>
<p>  def load_annotations(self, ann_file):</p>
<p>â€‹    â€œâ€â€Load annotation from COCO style annotation file.</p>
<p>â€‹    Args:</p>
<p>â€‹      ann_file (str): Path of annotation file.</p>
<p>â€‹    Returns:</p>
<p>```</p>
<p>ä¸»è¦æ˜¯çœ‹ä¸€ä¸‹<code>@DATASETS.register_module()</code>è¿™ä¸ªè£…é¥°å™¨ï¼Œå…³äºè£…é¥°å™¨çš„è¯­æ³•æ·±å…¥çš„éƒ¨åˆ†ä¸å†è¯´ï¼Œæˆ‘ä»¬è¿™é‡Œåªéœ€è¦çŸ¥é“è¿™ä¸ªå°±ç›¸å½“äºæˆ‘ä»¬æ³¨å†Œäº†æœ‰å…³çš„<code>Rigistry</code>,ä»è¿™ä¸ªå®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦å°±åƒå‰é¢ä¸€æ ·<code>dataset_type = &#39;CocoDataset&#39;</code>å°±å¯ä»¥å°†è¿™ä¸ªdataloaderæ”¾åˆ°MMdetä¸­ã€‚</p>
<p>å¦å¤–å¦‚æœè‡ªå·±è¦å†™dataloaderçš„è¯ï¼Œç±»éœ€è¦ç»§æ‰¿çš„å°±æ˜¯<code>from .custom import CustomDataset</code>ä¸­çš„<code>CustomDataset</code>.</p>
<p>å¦å¤–æˆ‘ä»¬è¿˜è¦æ³¨æ„çš„æ˜¯</p>
<h2 id="å›¾åƒåˆ†å‰²ç›˜ç¬¦åˆ‡ç‰‡æ•°æ®é¢„å¤„ç†æ“ä½œ"><a href="#å›¾åƒåˆ†å‰²ç›˜ç¬¦åˆ‡ç‰‡æ•°æ®é¢„å¤„ç†æ“ä½œ" class="headerlink" title="å›¾åƒåˆ†å‰²ç›˜ç¬¦åˆ‡ç‰‡æ•°æ®é¢„å¤„ç†æ“ä½œ"></a>å›¾åƒåˆ†å‰²ç›˜ç¬¦åˆ‡ç‰‡æ•°æ®é¢„å¤„ç†æ“ä½œ</h2><h3 id="Preface-2"><a href="#Preface-2" class="headerlink" title="Preface"></a>Preface</h3><p>æ˜¨å¤©æœ¬æ¥æ‰“ç®—è®¤çœŸåšä¸€ä¸‹å…³äºç›˜ç¬¦åˆ†ç±»çš„ä»»åŠ¡çš„ï¼Œæ²¡æƒ³åˆ°è¿˜æ˜¯æœ€ç»ˆæ²¡æœ‰å¼„ï¼Œå…‰é¡¾ç€æMMdetectionçš„æºç è¿™äº›ä¸œè¥¿äº†æ²¡æœ‰æ¥å¾—åŠæï¼Œç›®å‰å·²çŸ¥æ¥å£<code>inference_detector</code>è¿”å›çš„resultçš„ç»“æœäº†ï¼Œå°±æ˜¯ä¸€ä¸ªå…ƒç»„tupleï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ£€æµ‹æ¡†çš„ä½ç½®å’Œç½®ä¿¡åº¦ï¼Œç„¶åç¬¬äºŒä¸ªå…ƒç´ å°±æ˜¯åˆ†å‰²çš„ç»“æœï¼Œæ˜¯ä¸€ä¸ªä¸å›¾ç‰‡å¤§å°ç›¸åŒçš„ä¸€ä¸ªäºŒç»´çŸ©é˜µï¼Œç”±Trueå’ŒFalseç»„æˆã€‚</p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥å¼€å§‹å°è¯•åšå›¾åƒçš„å¤„ç†ã€‚</p>
<p>é¦–å…ˆæ„å»ºdetectorå¾—åˆ°ä¸€äº›å…·ä½“ç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/12/01/LqL6m6.png" alt></p>
<h3 id="å›¾åƒå¤„ç†ç®—æ³•åˆ†æä¸ç®—æ³•æ­¥éª¤å®ç°"><a href="#å›¾åƒå¤„ç†ç®—æ³•åˆ†æä¸ç®—æ³•æ­¥éª¤å®ç°" class="headerlink" title="å›¾åƒå¤„ç†ç®—æ³•åˆ†æä¸ç®—æ³•æ­¥éª¤å®ç°"></a>å›¾åƒå¤„ç†ç®—æ³•åˆ†æä¸ç®—æ³•æ­¥éª¤å®ç°</h3><h4 id="å¯¹äºåˆ†å‰²çš„ç»“æœé¢„å¤„ç†"><a href="#å¯¹äºåˆ†å‰²çš„ç»“æœé¢„å¤„ç†" class="headerlink" title="å¯¹äºåˆ†å‰²çš„ç»“æœé¢„å¤„ç†"></a>å¯¹äºåˆ†å‰²çš„ç»“æœé¢„å¤„ç†</h4><p>é¦–å…ˆï¼Œè¿™ä¸ªæ£€æµ‹æ¡†çš„ç»“æœå¹¶ä¸æ˜¯éå¸¸é è°±,å¾ˆæ˜æ˜¾å¦‚æœæˆ‘ä»¬é€‰æ‹©å¯¹å¾—åˆ°çš„bboxæ¥è¿›è¡Œå‡ç­‰åˆ†å‰²æ˜¯å®Œå…¨ä¸è¡Œçš„ï¼Œåˆ†å‰²çš„ç»“æœè¿˜è¦å¥½ä¸€äº›ç›¸å¯¹è€Œè¨€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥é€‰æ‹©è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨åˆ†å‰²æ•°æ®ä½†æ˜¯è¦å¯¹åˆ†å‰²æ•°æ®è¿›è¡Œä¸€äº›è½¬æ¢æˆ–è€…æ˜¯è¯´ä¿®è¡¥ã€‚</p>
<p>ç›®å‰ä¸€ä¸ªæƒ³æ³•æ˜¯å¯¹äºåˆ†å‰²ç»“æœçš„è¾¹ç•Œå–å¹³å‡å€¼æ¥å¾—åˆ°4æ¡å¯ä»¥ç”¨çš„è¾¹ç»„æˆä¸€ä¸ªæ–°çš„bboxã€‚ç„¶åæˆ‘ä»¬å†å¯¹å¾—åˆ°çš„æ–°çš„bboxè¿›è¡Œå¹³å‡åˆ‡åˆ†æˆ19ç­‰ä»½ï¼Œå½“ç„¶è¿™é‡Œæ²¡æœ‰è€ƒè™‘æ˜¯å¦æ˜¯å€¾æ–œçš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦åˆ‡å‡ºçš„å›¾ç‰‡è¦éƒ½æ˜¯æ°´å¹³çŸ©å½¢ï¼Œç„¶åæ ¹æ®åæ ‡å…³ç³»å°†æˆ‘ä»¬åˆ‡é™¤çŸ©å½¢éƒ¨åˆ†ä¸åŒ…å«ç›˜ç¬¦çš„éƒ¨åˆ†æ¶‚é»‘ï¼ˆæ‰€ä»¥å†™ä»£ç æ—¶ä¸å¦¨å…ˆå°†éç›˜ç¬¦éƒ¨åˆ†æ¶‚é»‘ã€‚ï¼‰</p>
<p>ç›®å‰è€ƒè™‘çš„ç®—æ³•æ­¥éª¤æ˜¯ï¼š</p>
<ul>
<li><p>æ ¹æ®æ„å»ºdetectorå¾—åˆ°çš„åˆ†å‰²ç»“æœçŸ©é˜µï¼Œæ ¹æ®è¾¹ç•Œå¹³å‡æ€æƒ³å¾—åˆ°ä¸€ä¸ª bbox</p>
</li>
<li><p>å¾—åˆ°bboxçš„å››ä¸ªé¡¶ç‚¹ï¼ˆä¸€å®šæ˜¯bboxçŸ©é˜µæœ€é å·¦ï¼Œæœ€é å³ï¼Œæœ€é ä¸Šï¼Œæœ€é ä¸‹çš„å››ä¸ªé¡¶ç‚¹ï¼‰ã€‚</p>
</li>
<li><p>æ ¹æ®å››ä¸ªé¡¶ç‚¹çš„å…³ç³»å¾—åˆ°å·¦å³çš„ä¸¤ç»„è¾¹çš„ç‚¹ï¼Œç„¶åæ ¹æ®å·¦å³ç­‰æ¯”ä¾‹å…³ç³»æ ‡æ³¨å¥½ä¸­é—´è¦åˆ‡åˆ†çš„18ä¸ªç‚¹ï¼Œè¿åŒç€å·¦å³ä¸¤ç«¯ç‚¹éƒ½æ”¾åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œä¸Šä¸‹éƒ½è¦æœ‰ï¼Œï¼ˆå…¶å®ä¹Ÿå°±é€šè¿‡ç»™bboxçš„çŸ©é˜µä¸Šä¸‹ä¸¤æ¡è¾¹ç­‰åˆ†æˆ19ä»½ï¼Œä»¥åˆ©äºåç»­ç”»å›¾åˆ‡å‰²ã€‚ï¼‰</p>
</li>
<li><p>å¼€å§‹åˆ‡å‰²ï¼Œå¹¶é€‰æ‹©å°†å›¾ç‰‡ä¸­éç›˜ç¬¦çš„éƒ¨åˆ†æ¶‚é»‘ï¼ˆè¿™ä¸ªå¯ä»¥åœ¨åˆ‡å‰²ä¹‹å‰å°±æ¶‚é»‘äº†ï¼‰</p>
</li>
<li><p>å¯¹ä¸€å¼ å›¾ç‰‡å¾—åˆ°çš„19ä¸ªç›˜ç¬¦æ ‡ä¸Šç§ç±»ï¼Œè‡³äºç§ç±»å¯ä»¥é€‰æ‹©åˆ©ç”¨å½“æ—¶çš„jsonæ–‡ä»¶æ¥æ ‡ç§ç±»ã€‚</p>
</li>
</ul>
<p>ç»†èŠ‚è¡¥å……ï¼š</p>
<ul>
<li><p>é¦–å…ˆé€šè¿‡å››ä¸ªé¡¶ç‚¹å¾—åˆ°ä¸€ä¸ªæ°´å¹³bboxå¯ä»¥å†™ä¸€ä¸ªå‡½æ•°å¤ç”¨</p>
</li>
<li><p>ç»™å®šä¸¤ä¸ªé¡¶ç‚¹å°†å…¶è¿çº¿ç­‰åˆ†å‰²æˆ19ä»½å¹¶è¿”å›è¯¥ç›´çº¿æ‰€åˆ†åæ ‡åˆ—è¡¨ï¼Œæˆ–è€…è¯´ç»™å®šå››ä¸ªé¡¶ç‚¹è¿”å›åˆ‡åˆ†å¥½çš„å„ä¸ªå°ç›˜ç¬¦é¡¶ç‚¹åæ ‡åˆ—è¡¨ï¼ˆæ„æ€å°±æ˜¯åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªåˆ†å¥½çš„å°æ¡†çš„å››ä¸ªé¡¶ç‚¹åæ ‡ï¼‰ã€‚</p>
</li>
<li><p>æ¶‚é»‘æ“ä½œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥ä¸º</p>
</li>
<li><p><strong>ä»¥ä¸Šæ‰€æœ‰çš„æ“ä½œéƒ½æ”¾åˆ°ä¸€ä¸ªç±»é‡Œç»Ÿä¸€å¤„ç†ï¼Œç„¶ååˆ°æ—¶å€™è°ƒç”¨ç›´æ¥æ„å»ºç±»çš„æ—¶å€™å°±è°ƒç”¨äº†è¿›è¡Œå®Œé¢„å¤„ç†æ“ä½œã€‚</strong></p>
</li>
</ul>
<h3 id="å¯¹äºæ™®é€šæ ‡æ³¨labelmeæ–‡ä»¶çš„ç»“æœé¢„å¤„ç†"><a href="#å¯¹äºæ™®é€šæ ‡æ³¨labelmeæ–‡ä»¶çš„ç»“æœé¢„å¤„ç†" class="headerlink" title="å¯¹äºæ™®é€šæ ‡æ³¨labelmeæ–‡ä»¶çš„ç»“æœé¢„å¤„ç†"></a><strong>å¯¹äºæ™®é€šæ ‡æ³¨labelmeæ–‡ä»¶çš„ç»“æœé¢„å¤„ç†</strong></h3><p>å› ä¸ºLabelmeæ–‡ä»¶æ˜¯å¯¹äºæ¯ä¸€ä¸ªå›¾ç‰‡éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„jsonæ–‡ä»¶ï¼Œç„¶åæ¯ä¸€ä¸ªjsonæ–‡ä»¶éƒ½ä¼šæœ‰å„ä¸ªç›˜ç¬¦çš„ä½ç½®ä¿¡æ¯è¿˜æœ‰å…·ä½“çš„åæ ‡ç§ç±»ï¼Œæ‰€ä»¥è¿™æ ·ä¸€æ¥ç›¸æ¯”äºåˆ†å‰²çš„ç»“æœè¦å¥½å¾ˆå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œæ€è·¯ç®€å•å¾ˆå¤šï¼š</p>
<ul>
<li><p>è¯»å–<code>.json</code>æ–‡ä»¶</p>
</li>
<li><p>å¯¹äºå°†æ¯ä¸ªå°ç›˜ç¬¦å››ä¸ªé¡¶ç‚¹è½¬åŒ–ä¸ºä¸€ä¸ªè¾ƒå¤§çš„bbox</p>
</li>
<li><p>å¤§æ¡†bboxå†…éç›˜ç¬¦éƒ¨åˆ†æ¶‚é»‘</p>
</li>
<li><p>ä¿å­˜ï¼Œæ³¨æ„å›¾ç‰‡æ ‡ç­¾çš„ä¿å­˜</p>
</li>
</ul>
<h3 id="æ™®é€šlabelmeæ–‡ä»¶è¯»å–åˆ†æ"><a href="#æ™®é€šlabelmeæ–‡ä»¶è¯»å–åˆ†æ" class="headerlink" title="æ™®é€šlabelmeæ–‡ä»¶è¯»å–åˆ†æ"></a>æ™®é€šlabelmeæ–‡ä»¶è¯»å–åˆ†æ</h3><h1 id="2021-12-2æ—¥ä¸‹åˆæ›´æ–°"><a href="#2021-12-2æ—¥ä¸‹åˆæ›´æ–°" class="headerlink" title="2021.12.2æ—¥ä¸‹åˆæ›´æ–°"></a>2021.12.2æ—¥ä¸‹åˆæ›´æ–°</h1><p>æ˜¨å¤©åšäº†å…³äºæ•°æ®é›†çš„æ•´ç†æ“ä½œä»¥åŠå…³äºæ•°æ®çš„è½¬åŒ–æ“ä½œï¼Œç›®å‰ä¸€ä¸ªæˆç†Ÿçš„æ•°æ®é›†å·²ç»è½¬åŒ–å®Œæˆï¼Œä¸è¿‡<strong>ç›¸å…³è®°å½•æ–‡æ¡£æ²¡æœ‰å®Œæˆ</strong>ï¼Œç¡®å®æ²¡æœ‰æ—¶é—´è®°å½•äº†ï¼Œç­‰è¿™ä¸¤å¤©è®°å½•ä¸€ä¸‹ã€‚<br>åŒæ—¶æ˜¨å¤©ä¹Ÿå†™äº†å…³äºæ–‡ä»¶çš„dataloaderçš„è¯»å–ï¼Œè¿™æ–¹é¢è¿˜æ˜¯èŠ±äº†ä¸€äº›å¿ƒæ€çš„ï¼Œç›®å‰æ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯æ„å»ºç›¸å…³æ¨¡å‹ç„¶åè¿›è¡Œæœ‰å…³çš„è®­ç»ƒï¼Œå½“ç„¶è¿™é‡Œè€ƒè™‘ä½¿ç”¨ä¸åŒçš„æœ‰å…³æ¨¡å‹æ¯”å¦‚è¯´resnet101, regnetè¿™ç±»éƒ½å°è¯•ä¸€ä¸‹ï¼Œå½“ç„¶å¯ä»¥ç›´æ¥ä»torchvision.modelsç›´æ¥å¯¼å…¥æœ‰å…³çš„æ¨¡å‹ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ­£å¥½æˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªçš„æ¨¡å‹çš„è®­ç»ƒï¼Œæ•°æ®å¯è§†åŒ–ï¼Œè°ƒæ•´å¯è§†åŒ–ç­‰ç­‰è¿™ä¸€ç³»åˆ—çš„æ“ä½œéƒ½å°è¯•å­¦ä¹ æ“ä½œä¸€éï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿæ•´è¿‡å¥½å¤šéï¼Œä½†æ˜¯è‡ªä»å­¦äº†mmdetectionä¹‹åå°±å¾ˆå°‘å¼„äº†ï¼Œå¯ä»¥å†æ·±å…¥æ¢ç´¢ä¸€ä¸‹ã€‚</p>
<p>å¦å¤–</p>
<p>ä¸€äº›å‚è€ƒæ–‡æ¡£ï¼š</p>
<ul>
<li><a href="https://blog.csdn.net/weixin_36670529/article/details/105910572" target="_blank" rel="noopener">https://blog.csdn.net/weixin_36670529/article/details/105910572</a></li>
<li></li>
</ul>
<h1 id="2021-12-3æ—¥-amp-amp-4æ—¥-amp-amp-5æ—¥æ›´æ–°"><a href="#2021-12-3æ—¥-amp-amp-4æ—¥-amp-amp-5æ—¥æ›´æ–°" class="headerlink" title="2021.12.3æ—¥&amp;&amp;4æ—¥&amp;&amp;5æ—¥æ›´æ–°"></a>2021.12.3æ—¥&amp;&amp;4æ—¥&amp;&amp;5æ—¥æ›´æ–°</h1><h2 id="Preface-3"><a href="#Preface-3" class="headerlink" title="Preface"></a>Preface</h2><p>æ•°æ®å¤„ç†æœ‰å…³çš„è®°å½•æ–‡æ¡£æ˜¨å¤©å·²ç»æ•´ç†å®Œæ¯•ã€‚ä¸ºäº†å¸å–æ•™è®­ï¼Œä»¥åè¿˜æ˜¯è¾¹å†™è¾¹æ•´ç†æ–‡æ¡£æ¯”è¾ƒå¥½ï¼Œé™¤éæ˜¯æ—¶é—´è¿‡äºç´§æ€¥ã€‚</p>
<p>ä»Šå¤©å°±å†™ä¸€ä¸‹æœ‰å…³æ¨¡å‹ï¼Œæ ¹æ®ç›®å‰çš„è¿›å±•ï¼Œä»»åŠ¡ä¸»è¦å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…³äºéªŒè¯é›†ã€è®­ç»ƒé›†çš„åˆ’åˆ†</li>
<li>train_one_epochå‡½æ•°</li>
<li>è®¡ç®—éªŒè¯é›†å‡†ç¡®ç‡çš„å‡½æ•°</li>
<li>ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†</li>
<li>ä½¿ç”¨tqdm</li>
</ul>
<h2 id="éªŒè¯é›†ã€è®­ç»ƒé›†çš„åˆ’åˆ†"><a href="#éªŒè¯é›†ã€è®­ç»ƒé›†çš„åˆ’åˆ†" class="headerlink" title="éªŒè¯é›†ã€è®­ç»ƒé›†çš„åˆ’åˆ†"></a>éªŒè¯é›†ã€è®­ç»ƒé›†çš„åˆ’åˆ†</h2><p>å¤§æ¦‚8ï¼š2åˆ’åˆ†ï¼Œå…·ä½“éš¾åº¦å¹¶ä¸é«˜ã€‚ä»…ä»…æ˜¯è®°å¾—ä½¿ç”¨å‡½æ•°shutilå°±OKäº†ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—ç”¨äºåˆ’åˆ†éªŒè¯é›†å’Œæµ‹è¯•é›†ï¼Œå¤§æ¦‚æ¯”ä¾‹ä¸º8ï¼š2"""</span>

<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> glob

<span class="token keyword">def</span> <span class="token function">move_file</span><span class="token punctuation">(</span>imgs<span class="token punctuation">,</span>  new_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ç§»åŠ¨å›¾ç‰‡ä»æ—§è·¯å¾„ç§»åˆ°æ–°è·¯å¾„'''</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>new_path<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># filelist = os.listdir(old_path) # åˆ—å‡ºè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶,listdirè¿”å›çš„æ–‡ä»¶åˆ—è¡¨æ˜¯ä¸åŒ…å«è·¯å¾„çš„ã€‚</span>
    filelist <span class="token operator">=</span> imgs
    <span class="token keyword">print</span><span class="token punctuation">(</span>filelist<span class="token punctuation">)</span>
    <span class="token keyword">for</span> file <span class="token keyword">in</span> filelist<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># file = file - "/home/lry/data/780b_std/"</span>
        src <span class="token operator">=</span> file
        dst <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_path<span class="token punctuation">,</span> file<span class="token punctuation">[</span>len<span class="token punctuation">(</span><span class="token string">'/home/lry/data/780b_singe_padded/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'src:'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'dst:'</span><span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># old_path = "/home/lry/data/780b_std"</span>

new_val <span class="token operator">=</span> <span class="token string">"/home/lry/data/780b_singe_padded_std/val"</span>
new_train <span class="token operator">=</span> <span class="token string">"/home/lry/data/780b_singe_padded_std/train"</span>

pics <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"/home/lry/data/780b_singe_padded/*.jpg"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(pics)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>len<span class="token punctuation">(</span>pics<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(pics[0][-30:])</span>
<span class="token comment" spellcheck="true"># print(len(pics))</span>
<span class="token comment" spellcheck="true"># print(pics[0][len("/home/lry/data/780b_std/"):-5] + ".jpg")</span>
<span class="token comment" spellcheck="true"># print(pics[0][:-4])</span>
<span class="token comment" spellcheck="true"># print(pics)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"moving...."</span><span class="token punctuation">)</span>
move_file<span class="token punctuation">(</span>pics<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">702</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_train<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train end!"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"moving..."</span><span class="token punctuation">)</span>
move_file<span class="token punctuation">(</span>pics<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">702</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> new_val<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"val end!"</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># if __name__ == '__main__':</span>
<span class="token comment" spellcheck="true">#     pics = glob.glob("/home/lry/data/780b_singe_padded_std/train/*.jpg")</span>
<span class="token comment" spellcheck="true">#     print(len(pics))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="train-one-epochå‡½æ•°"><a href="#train-one-epochå‡½æ•°" class="headerlink" title="train_one_epochå‡½æ•°"></a>train_one_epochå‡½æ•°</h2><p>è¿™ä¸ªå…·ä½“çš„ä¸å¤šè¯´ï¼Œè¿™é‡Œå°±å†™ä¸€ä¸‹å¤§è‡´çš„æµç¨‹ï¼š</p>
<ol>
<li>åˆ©ç”¨dataloaderåŠ è½½æ•°æ®</li>
<li>æ•°æ®ã€æ¨¡å‹éƒ¨ç½²åˆ°cudaGPUä¸­</li>
<li>å‰å‘ä¼ æ’­</li>
<li>è®¡ç®—loss</li>
<li>åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦</li>
<li>è°ƒç”¨ä¼˜åŒ–å™¨ä¼˜åŒ–æ›´æ–°æƒé‡</li>
<li>åœ¨torch.no_gradæ¡ä»¶ä¸‹è®¡ç®—valå‡†ç¡®ç‡ã€‚</li>
</ol>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_one_epoch</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> trainloader<span class="token punctuation">,</span> valloader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> criterion<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    è®­ç»ƒä¸€ä¸ªepochï¼Œè¿”å›è¯¥epochçš„train_loss, train_acc, val_accå‡†ç¡®ç‡
    '''</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># train</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    train_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">:</span>

        labels<span class="token punctuation">,</span> inputs <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>

        output <span class="token operator">=</span> model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

        _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span>max<span class="token punctuation">(</span>output<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
        train_loss <span class="token operator">+=</span> loss
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

    train_loss <span class="token operator">=</span> train_loss <span class="token operator">/</span> <span class="token number">2808</span>
    train_acc <span class="token operator">=</span> correct <span class="token operator">/</span> total

    <span class="token comment" spellcheck="true"># valå‡†ç¡®ç‡</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> data <span class="token keyword">in</span> valloader<span class="token punctuation">:</span>
            labels<span class="token punctuation">,</span> images <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span>max<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    val_acc <span class="token operator">=</span> correct <span class="token operator">/</span> total

    <span class="token keyword">return</span> train_loss<span class="token punctuation">,</span> train_acc<span class="token punctuation">,</span> val_acc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="å…³äºå¯¼å…¥æ¨¡å‹"><a href="#å…³äºå¯¼å…¥æ¨¡å‹" class="headerlink" title="å…³äºå¯¼å…¥æ¨¡å‹"></a>å…³äºå¯¼å…¥æ¨¡å‹</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚<br>æ‰€æœ‰æ¨¡å‹éƒ½åœ¨torchvisionåº“é‡Œé¢ï¼Œå…¶ä¸­torchvision.modelsä¿å­˜å®šä¹‰äº†è®¸è®¸å¤šå¤šæˆ‘ä»¬éœ€è¦çš„æ¨¡å‹ã€‚å…·ä½“å¯¼å…¥æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼šç›´æ¥<code>torchivision.models.resnet50(pretrained=True)</code>åƒè¿™ç±»å°±è¡Œ,å½“ç„¶å¦‚æœæˆ‘ä»¬æƒ³è¦æ”¹ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚resnet50æœ€åæœ‰ä¸€ä¸ªä¸€å±‚çš„å…¨è¿æ¥å±‚ï¼Œæˆ‘ä»¬æƒ³è¦æ”¹ä¸€ä¸‹è¿™ä¸ªæœ€åå…¨è¿æ¥å±‚çš„è¾“å‡º,æ¯”æ–¹è¯´ç›®å‰æˆ‘æœ‰14ç±»è¾“å‡ºä½†æ˜¯torchvisionå®˜æ–¹çš„resnet50çš„modelé»˜è®¤æœ€åçš„å…¨è¿æ¥å±‚æ˜¯<code>nn.Linear(2048, 1000)</code>,å› ä¸ºè¿™ä¸ªæ˜¯åŸºäº<code>Imagenet</code>æ•°æ®é›†çš„ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦æ›´æ”¹ï¼Œä¸€ä¸ªæ–¹æ³•æ˜¯å¯ä»¥æŸ¥çœ‹è¯¥æ¨¡å‹pytorchå®šä¹‰çš„æºä»£ç ï¼Œå› ä¸º<br><code>torchivision.models.resnet50(pretrained=True)</code>è¿™ä¸ªæˆ–è€…è¯´è¿™ç±»å‡½æ•°æ˜¯æœ‰ç›¸å…³çš„å‚æ•°ç”¨æ¥æ”¹æœ€åå…¨è¿æ¥å±‚çš„outputçš„ï¼Œæˆ–è€…å¯ä»¥é€‰æ‹© ç›´æ¥æ›´æ”¹ï¼Œå°±åƒæˆ‘è¿™é‡Œä¸€æ ·ï¼š</p>
</blockquote>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># å¯¼å…¥æ¨¡å‹</span>
model <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet50<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># print(model)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>fc<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># æŸ¥çœ‹é»˜è®¤æœ€åä¸€å±‚å…¨è¿æ¥å±‚çš„ç»“æ„</span>
<span class="token comment" spellcheck="true"># print(type(model.fc))</span>
<span class="token comment" spellcheck="true"># print(dict(model.fc.named_parameters()).keys())</span>
model<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>fc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°±æ˜¯åˆ©ç”¨<code>model.fc = nn.Linear(2048, num_classes)</code>æ¥å®šä¹‰æœ€åä¸€å±‚çš„å‚æ•°ï¼Œè¿™ä¸ªå¾ˆå·§å¦™å®é™…ä¸Šï¼Œå°±ç›¸å½“äºé‡æ–°å®šä¹‰äº†ä¸€éï¼Œæ”¹äº†ç›¸å…³çš„ç»“æ„ã€‚</p>
<h2 id="å…³äºéƒ¨ç½²åˆ°cudaä¸Š"><a href="#å…³äºéƒ¨ç½²åˆ°cudaä¸Š" class="headerlink" title="å…³äºéƒ¨ç½²åˆ°cudaä¸Š"></a>å…³äºéƒ¨ç½²åˆ°cudaä¸Š</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚</p>
</blockquote>
<p>è¿™ä¸ªæˆ‘ä¹‹å‰ä¸€ç›´ä½¿ç”¨çš„æ˜¯å…³äº<code>device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</code>æ¥æŒ‡å®šgpuè®­ç»ƒï¼Œä½†æ˜¯ç»“æœå´å¹¶ä¸æ˜¯æˆ‘æƒ³çš„é‚£æ ·åœ¨ç‰¹å®šçš„gpuä¸Šè®­ç»ƒ. è¿™é‡Œç”¨åˆ°äº†ä¹‹å‰ç»„é•¿å»ºè®®çš„ä¸€ç§ç”¨æ³•ï¼Œä¹Ÿæ˜¯ä»–ä»¬å¸¸ç”¨çš„åšæ³•,ç”šè‡³å½“æ—¶æˆ‘è¿˜åœ¨åˆ†å‰²ä»»åŠ¡ä¸­åšäº†çš„ï¼Œè¿™æ˜¯æˆ‘å½“æ—¶åˆ†å‰²ä»»åŠ¡çš„è¿è¡Œä»£ç ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">CUDA_VISIBLE_DEVICES<span class="token operator">=</span><span class="token number">1</span> python tools<span class="token operator">/</span>test<span class="token punctuation">.</span>py configs<span class="token operator">/</span>fenghuo<span class="token operator">/</span>mask_rcnn_r50_caffe_fpn_mstrain<span class="token operator">-</span>poly_1x_fenghuo<span class="token punctuation">.</span>py work_dirs<span class="token operator">/</span>mask_rcnn_r50_caffe_fpn_mstrain<span class="token operator">-</span>poly_1x_fenghuo<span class="token operator">/</span>latest<span class="token punctuation">.</span>pth  <span class="token operator">-</span><span class="token operator">-</span>eval bbox segm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å®é™…ä¸Šä¹Ÿå°±æ˜¯åœ¨ç›¸å…³è¿è¡Œpythonå‘½ä»¤å‰åŠ äº†<code>CUDA_VISIBLE_DEVICES=1</code>,CUDAï¼š1ï¼Œæœ‰æ—¶å€™è¦ä½¿ç”¨å¤šå¼ å¡å¹¶è¡Œå¯ä»¥é€‰æ‹©ä½¿ç”¨é€—å·åˆ†å¼€ä¸¤å¼ å¡ï¼Œä¾‹å¦‚ï¼šCUDA_VISIBLE_DEVICES=1, 2ã€‚<br>è¿™æ ·åšä¹‹åæ¨¡å‹ä¼šè¿›è¡Œå•å¡è®­ç»ƒï¼Œå¦å¤–å½“æˆ‘ä»¬è¦è¿›è¡Œå®æ—¶ç›‘æ§æ˜¾å­˜å’Œè¿›ç¨‹ç›¸å…³ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>watch</code>å‘½ä»¤ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">watch <span class="token operator">-</span>n <span class="token number">1</span> nvidia<span class="token operator">-</span>smi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™ä¸ªä»£è¡¨æ¯ä¸€ç§’åˆ·æ–°ä¸€æ¬¡æ˜¾å¡ä½¿ç”¨æƒ…å†µã€‚<br>å…³äºå¤šå¡è¿™æ–¹é¢ï¼Œæ˜¯ä¸€é—¨å¤§å­¦é—®ï¼Œæš‚æ—¶å…ˆä¸åœ¨è¿™é‡Œå±•å¼€è¯´ã€‚</p>
<h2 id="å…³äºbatch-size"><a href="#å…³äºbatch-size" class="headerlink" title="å…³äºbatch_size"></a>å…³äºbatch_size</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚<br>æœ€ä¸€å¼€å§‹çš„æ—¶å€™è°ƒçš„batch_size=128ï¼Œä½†æ˜¯ç»“æœä¸€ä¸‹å­æ˜¾å­˜ä¸è¶³å¯¼è‡´ç¨‹åºç»ˆæ­¢äº†ã€‚æœ¬æ¥æˆ‘ä»¥ä¸ºè¿™ä¹ˆå¥½çš„æ˜¾å¡ï¼Œå®³ã€‚è¿˜æ˜¯æˆ‘å¤ªè‚¤æµ…äº†ï¼Œæœ¬èº«å›¾ç‰‡å¤§å°å°±ä¸å°ï¼Œä¸€å¼ å›¾ç‰‡<code>1800Ã—180</code>è¿™ä¹ˆå¤§çš„å›¾ç‰‡ç¡®å®(ä¸€èˆ¬ç§‘ç ”æˆ–æ˜¯ä¸€äº›ç»å…¸æ•°æ®é›†è®­ç»ƒéƒ½æ˜¯<code>224Ã—224</code>è¿™ç±»å¤§å°),å†åŠ ä¸Šè¿™äº›æ˜¾å­˜ä»€ä¹ˆçš„å’Œå¡æœ¬èº«æ˜¯2080tiè¿˜æ˜¯3090æ²¡æœ‰å…³ç³»ï¼Œè¿™ä¸ªå’Œæ˜¾å­˜æœ‰å…³ç³»ã€‚è€Œè¿™ä¸ªæœåŠ¡å™¨çš„æ˜¾å­˜æ˜¯12Gï¼Œä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥è¯´æœ€å¥½è¿˜æ˜¯ä¸è¦ç”¨åˆ°è¿™ä¹ˆå¤§çš„batch_sizeäº†ï¼Œåæ¥æ”¹æˆ<code>batch_size=4</code>,ç»“æœå‘ç°ä»…ä»…4ä¸ªbatch_sizeå°±æ¶ˆè€—äº†å‡ ä¹4ä¸ªGçš„æ˜¾å­˜ï¼Œåæ¥è¯•äº†è¯•å°†batch_sizeè°ƒè‡³10ï¼Œç»“æœå·®ä¸å¤šå äº†8ä¸ªGçš„æ˜¾å­˜ï¼Œé¢„è®¡batch_size=16èƒ½å®Œå…¨å æ»¡ï¼Œä¸è¿‡è¿™é‡Œæ²¡æœ‰ç»§ç»­å®éªŒã€‚</p>
</blockquote>
<h2 id="å…³äºå¹¶è¡ŒGPUè®¡ç®—"><a href="#å…³äºå¹¶è¡ŒGPUè®¡ç®—" class="headerlink" title="å…³äºå¹¶è¡ŒGPUè®¡ç®—"></a>å…³äºå¹¶è¡ŒGPUè®¡ç®—</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚</p>
</blockquote>
<h2 id="è¿›åº¦æ¡tqdm"><a href="#è¿›åº¦æ¡tqdm" class="headerlink" title="è¿›åº¦æ¡tqdm"></a>è¿›åº¦æ¡tqdm</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚<br>è¿›åº¦æ¡æ€ä¹ˆç”¨ï¼Œç›®å‰æˆ‘åªä¼šç”¨éå¸¸åŸºæœ¬çš„ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ª<code>tqdm.tqdm()</code>å†…å«ä¸€ä¸ªiterableçš„å‚æ•°æ¯”å¦‚åˆ—è¡¨è¿™ç±»ã€‚ç„¶åæ”¾åˆ°foré‡Œé¢è¿›è¡Œå¾ªç¯ã€‚å½“ç„¶è¿™ä¼¼ä¹å¯¹æˆ‘ç›®å‰æ¥è¯´ç®—æ˜¯å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æ›´è¿›ä¸€æ­¥çš„è¯å¯ä»¥çœ‹çœ‹<a href="https://github.com/tqdm/tqdm" target="_blank" rel="noopener">GitHubæºç åœ°å€</a>ï¼Œä¹Ÿæœ‰ä¸€ä¸ªè¾ƒä¸ºè¯¦ç»†çš„introduction.</p>
</blockquote>
<h2 id="ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³"><a href="#ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³" class="headerlink" title="ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³"></a>ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³</h2><p>ä»¥ä¸Šçš„ä»»åŠ¡æˆåŠŸå†™å®Œï¼Œæ¨¡å‹ä¹ŸæˆåŠŸè·‘å®Œï¼Œç»“æœå¦‚ä¸‹(ä¸€ä¸ªç®€å•çš„ç»“æœ)ï¼š<br><a href="https://imagelol.com/image/LnBiyC" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/12/03/LnBiyC.png" alt></a><br>ç›®å‰åªæ˜¯å®Œæˆäº†ä¸€ä¸ªå°çš„demoè€Œå·²ï¼Œæ•´ä¸ªé¡¹ç›®æœ‰ç€éå¸¸å¤šçš„ä»»åŠ¡éœ€è¦ç»§ç»­åšï¼Œè¿˜æœ‰å¥½å¤šä»£ç ç»§ç»­å†™ã€‚<br>æ¥ä¸‹æ¥è¦å®Œæˆçš„ä»¥åŠç›®å‰å·¥ä½œçš„ä¸è¶³åœ¨äºï¼š</p>
<ul>
<li>æ ‡ç­¾æ²¡æœ‰åˆå¹¶æ¥è®­ç»ƒï¼Œç›®å‰å„ä¸ªå°ç±»æ²¡æœ‰åˆå¹¶ï¼Œä»…ä»…æ˜¯æŠŠæ¯ä¸€ä¸ªå°ç±»éƒ½åˆ†å¼€è®­ç»ƒäº†ã€‚</li>
<li>batch_sizeå¯ä»¥ç»§ç»­è°ƒé«˜ï¼Œå› ä¸ºç›®å‰çš„ä»»åŠ¡å°è¯•batch_size=4å¯ä»¥å‘ç°æ˜¾å­˜å ç”¨äº†4000å¤šå…†ï¼Œç„¶è€ŒæœåŠ¡å™¨å•å¡2080tiå¯ä»¥ä½¿ç”¨è¶…è¿‡11000å…†çš„æ˜¾å­˜ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•è·‘æ»¡ã€‚å½“ç„¶ç›®å‰4å¼ å¡æœ‰2å¼ æ˜¯ç©ºé—²çš„ï¼Œå¦‚æœè¦è¿›ä¸€æ­¥ä½¿ç”¨2å¼ å¡å¹¶è¡Œçš„è¯ï¼Œå¯ä»¥è¯•è¯•<a href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html" target="_blank" rel="noopener">DISTRIBUTED DATA PARALLEL</a>,å½“ç„¶è¿™ä¸ªå¯èƒ½ç›®å‰æ¯”è¾ƒéš¾ï¼Œä¸è¿‡å¯ä»¥é€‚å½“çœ‹ä¸€çœ‹ï¼Œè¿™æ ·çš„è¯batch_sizeç”šè‡³å¯ä»¥è°ƒåˆ°20ã€‚</li>
<li>ç›®å‰ä»…ä»…å¯¼å…¥ä½¿ç”¨äº†å®˜æ–¹çš„resnet101ï¼Œè¿˜å¯ä»¥è¯•è¯•å…¶ä»–æ¨¡å‹</li>
<li>epochå¯ä»¥å¾€ä¸Šè°ƒè°ƒè¯•è¯•</li>
<li><strong>æ¨¡å‹ã€è®­ç»ƒlogè®°å¾—ä¿å­˜</strong>ï¼ŒåŒ…æ‹¬ä¸€äº›å…³é”®çš„æ•°æ®å¯ä»¥æ”¾åˆ°ä¸€ä¸ªtxtæ–‡æ¡£é‡Œé¢ï¼Œå†™ä»£ç å®ç°logçš„è®°å½•ï¼Œå¯ä»¥å‚è€ƒmmdetectionï¼Œå®ƒçš„è®°å½•å°±éå¸¸è¯¦ç»†ã€‚</li>
</ul>
<h2 id="ä¿å­˜è®­ç»ƒæƒé‡ï¼Œæ¨¡å‹æ–¹æ³•"><a href="#ä¿å­˜è®­ç»ƒæƒé‡ï¼Œæ¨¡å‹æ–¹æ³•" class="headerlink" title="ä¿å­˜è®­ç»ƒæƒé‡ï¼Œæ¨¡å‹æ–¹æ³•"></a>ä¿å­˜è®­ç»ƒæƒé‡ï¼Œæ¨¡å‹æ–¹æ³•</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚</p>
</blockquote>
<p>ä¸»è¦å‚è€ƒçš„å°±æ˜¯ä»¥ä¸‹æ–‡æ¡£ä»¬ï¼š</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/38056115" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38056115</a></li>
<li><a href="https://blog.csdn.net/weixin_40522801/article/details/106563354" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40522801/article/details/106563354</a></li>
<li><a href="https://pytorch.org/tutorials/beginner/saving_loading_models.html" target="_blank" rel="noopener">https://pytorch.org/tutorials/beginner/saving_loading_models.html</a></li>
</ul>
<p>å½“ç„¶ä»£ç å†™å¾—å‚è€ƒçš„æœ€å¼€å§‹é‚£ç¯‡çŸ¥ä¹æ–‡æ¡£ï¼Œæ¨¡å‹ä¿å­˜ä»£ç ä¸ºï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">launchTimestamp <span class="token operator">=</span> str<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'state_dict'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'best_loss'</span><span class="token punctuation">:</span> best_loss<span class="token punctuation">,</span>
                            <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                           <span class="token string">'/home/lry/projects/mmdetection/lry/model_classification/checkpoints'</span> <span class="token operator">+</span> <span class="token string">'/resnet50-m-'</span> <span class="token operator">+</span> launchTimestamp <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span><span class="token string">"%.4f"</span> <span class="token operator">%</span> best_loss<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.pth.tar'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'model {launchTimestamp} saved!'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç›®å‰è¿˜æ²¡å°è¯•è¿‡åŠ è½½æ¨¡å‹ï¼Œå…ˆä¸è€ƒè™‘äº†ï¼Œä»¥åå†è¯´å§ã€‚</p>
<h2 id="æ¨¡å‹çš„ç±»åˆ«åˆå¹¶"><a href="#æ¨¡å‹çš„ç±»åˆ«åˆå¹¶" class="headerlink" title="æ¨¡å‹çš„ç±»åˆ«åˆå¹¶"></a>æ¨¡å‹çš„ç±»åˆ«åˆå¹¶</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚<br>è¿™æ–¹é¢å®é™…ä¸Šå¤§å¤šéƒ½æ˜¯è„æ´»ç´¯æ´»ï¼Œéœ€è¦ä»‹ç»çš„æ°æ°ä¸å¤ªå¤š.<br>ä¸è¿‡ç¡®å®æ¯”è¾ƒè€ƒéªŒä»£ç èƒ½åŠ›ã€‚</p>
</blockquote>
<h2 id="å…³äºlr-scheduler"><a href="#å…³äºlr-scheduler" class="headerlink" title="å…³äºlr_scheduler"></a>å…³äºlr_scheduler</h2><blockquote>
<p>2021.12.4æ›´æ–°ã€‚<br>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://www.kaggle.com/isbhargav/guide-to-pytorch-learning-rate-scheduling" target="_blank" rel="noopener">https://www.kaggle.com/isbhargav/guide-to-pytorch-learning-rate-scheduling</a></p>
</blockquote>
<h2 id="åˆ†ç±»ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³"><a href="#åˆ†ç±»ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³" class="headerlink" title="åˆ†ç±»ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³"></a>åˆ†ç±»ä»»åŠ¡å®Œæˆå¯ç¤ºä¸ä¸è¶³</h2><p>æœ¬äººä»»åŠ¡æ¥è¿‘æ”¶å°¾ï¼Œç›®å‰è¿˜æ˜¯éå¸¸æ»¡æ„çš„ï¼Œè‡³å°‘å¯¹äºç»“æœæ¥è¯´ï¼š<br><a href="https://imagelol.com/image/LnTsAT" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/12/03/LnTsAT.png" alt></a></p>
<p>æœ¬æ¥æˆ‘è¿˜æƒ³è¿›ä¸€æ­¥å°è¯•ä¸€ä¸‹ä¸åŒçš„å­¦ä¹ ç‡å’Œä¸€äº›å…¶ä»–çš„æ¨¡å‹ï¼Œä½†æ˜¯ç”±äºæœ¬æ¬¡å®éªŒå®é™…ä¸Šå¯¹äºä»»åŠ¡æœ¬èº«å·²ç»å®Œæˆäº†ï¼Œå¦‚æœæƒ³è¦æ·±å…¥ç ”ç©¶å¯ä»¥ä¹‹ååšç ”ç©¶æ—¶æˆ–æ˜¯æƒ³è¦æ¢ç´¢å†è¯´äº†ã€‚<br>è€Œå¯¹äºæœ¬æ¬¡æ¥çœ‹ï¼Œå®é™…ä¸Šå®Œå…¨å¤Ÿäº†ã€‚æ¥ä¸‹æ¥å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘æƒ³åšçš„ä¸€äº›ä¸œè¥¿å°±æ˜¯ï¼š</p>
<ul>
<li><a href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html" target="_blank" rel="noopener">DISTRIBUTED DATA PARALLEL</a>å¤šå¡è®­ç»ƒï¼Œå¯ä»¥é—®ä¸€ä¸‹å¼ ç»´å¤©å­¦å§å¥¹çš„å¤šå¡è®­ç»ƒæ˜¯æ€ä¹ˆå¼„çš„ã€‚</li>
<li>å¤šçœ‹çœ‹åˆ«äººå†™çš„pytorchä»£ç ï¼Œä¸ç®¡æ˜¯å“ªä¸€ç±»çš„ä»£ç éƒ½è¡Œ</li>
<li>å…³äºåˆ†å‰²ä»»åŠ¡çš„iouè°ƒèŠ‚æ¢ç´¢</li>
<li>transformerè®ºæ–‡çš„é˜…è¯»ä¸å­¦ä¹ ï¼Œå°¤å…¶æ˜¯å…³äº</li>
<li>å†™å®Œä¸Šé¢çš„æ–‡æ¡£(<del>å”‰å¥½å¤šæ–‡æ¡£è¦å†™ï¼Œå¯ä»¥å…ˆå†™å¤šå¡è®­ç»ƒéƒ¨åˆ†ï¼šè¾¹å­¦å¤šå¡è®­ç»ƒè¾¹å†™</del>)</li>
<li>å¯¼å…¥æ¨¡å‹æ–¹å¼ä¹Ÿå¯ä»¥çœ‹çœ‹<code>hello-dian-ai</code>ä¸­çš„lab2å¯¼å…¥é¢„è®­ç»ƒbackboneçš„æ–¹å¼ã€‚</li>
</ul>
<p>è¿™æ˜¯æˆªæ­¢åˆ°æœ¬å‘¨äº”æˆ‘çš„è¿™äº”å¤©ç›¸å…³ä»»åŠ¡ä»£ç å’Œæ—¶é—´çš„ç»Ÿè®¡ï¼Œpythonä»£ç æ•²äº†16ä¸ªå°æ—¶ï¼Œmarkdownç¬”è®°è®°äº†5ä¸ªå°æ—¶ã€‚æ€»ä½“æ¥çœ‹æœ¬å‘¨ä¸‰ï¼ˆ12.1æ—¥ï¼‰æ•²å¾—æœ€å¤šï¼Œæ•²äº†7ä¸ªå¤šå°æ—¶pythonä»£ç ã€‚å¯¹äºå·¥ä½œè¿˜æ˜¯éå¸¸æ»¡æ„çš„ï¼<br><a href="https://imagelol.com/image/LnT0pO" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://s6.jpg.cm/2021/12/03/LnT0pO.png" alt></a></p>
<h2 id="DISTRIBUTED-DATA-PARALLEL"><a href="#DISTRIBUTED-DATA-PARALLEL" class="headerlink" title="DISTRIBUTED DATA PARALLEL"></a>DISTRIBUTED DATA PARALLEL</h2><p>Reference:</p>
<ul>
<li><a href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html" target="_blank" rel="noopener">https://pytorch.org/tutorials/intermediate/ddp_tutorial.html</a></li>
<li><a href="https://github.com/tczhangzhi/pytorch-distributed" target="_blank" rel="noopener">https://github.com/tczhangzhi/pytorch-distributed</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/31558973" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/31558973</a></li>
<li><a href="https://www.cnblogs.com/jiangkejie/p/14603479.html" target="_blank" rel="noopener">https://www.cnblogs.com/jiangkejie/p/14603479.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/86441879" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/86441879</a></li>
</ul>
<h2 id="ä¿®æ”¹åˆ†å‰²ä»»åŠ¡çš„IOU"><a href="#ä¿®æ”¹åˆ†å‰²ä»»åŠ¡çš„IOU" class="headerlink" title="ä¿®æ”¹åˆ†å‰²ä»»åŠ¡çš„IOU"></a>ä¿®æ”¹åˆ†å‰²ä»»åŠ¡çš„IOU</h2><p>mmlabæœ€åˆé»˜è®¤çš„é…ç½®ä¸ºï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># model training and testing settings</span>
    train_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            allowed_border<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rpn_proposal<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mask_size<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            score_thr<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
            mask_thr_binary<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬è¿™é‡Œè°ƒæ•´äº†ç›¸å…³çš„<code>pos_iou_thread=0.9 or 0.8</code>,å½“ç„¶rpnå’Œrcnnä»¥åŠnmséƒ¨åˆ†éƒ½è°ƒäº†ã€‚è°ƒæ•´åä¸ºï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">    <span class="token comment" spellcheck="true"># model training and testing settings</span>
    train_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            allowed_border<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rpn_proposal<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            assigner<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>
                pos_iou_thr<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
                neg_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                min_pos_iou<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sampler<span class="token operator">=</span>dict<span class="token punctuation">(</span>
                type<span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>
                num<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
                pos_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mask_size<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>
            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    test_cfg<span class="token operator">=</span>dict<span class="token punctuation">(</span>
        rpn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            nms_pre<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rcnn<span class="token operator">=</span>dict<span class="token punctuation">(</span>
            score_thr<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
            nms<span class="token operator">=</span>dict<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span> iou_threshold<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            max_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
            mask_thr_binary<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªæ–‡æ¡£æ˜¯æˆ‘æ‰¾configæ¥å›æ‰¾æœ€åå›æº¯åˆ°çš„ï¼Œç”±äºå›æº¯è¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼Œæ–‡ä»¶åä»€ä¹ˆçš„å‘½åï¼Œæœ€åä¹Ÿæ˜¯æ‰¾äº†æŒºé•¿æ—¶é—´æ‰¾<strong>å‡†</strong>äº†ã€‚ç²¾ç¡®ä½ç½®åœ¨<code>/home/lry/projects/mmdetection/configs/_base_/models/mask_rcnn_r50_fpn.py</code>è¿™é‡Œã€‚</p>
<p>åˆ«çš„æ²¡æœ‰å¤ªå¤šæ”¹å˜ï¼Œå°±è®­ç»ƒå®Œäº†ä¹‹åæœ‰äº›äº†ä¸€ä¸ªæ–°çš„inferenceçš„pythonä»£ç ï¼Œåœ¨<code>/home/lry/projects/mmdetection/lry/compare_sege.py</code>,ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""æœ¬æ¨¡å—æ˜¯ä¸€ä¸ªå°demoï¼Œç”¨æ¥å¯¹æ¯”å•å¼ å›¾ç‰‡ç»“æœæ€ä¹ˆæ ·"""</span>

<span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>apis <span class="token keyword">import</span> init_detector<span class="token punctuation">,</span>inference_detector<span class="token punctuation">,</span> show_result_pyplot
<span class="token keyword">import</span> mmcv
<span class="token keyword">import</span> os
<span class="token keyword">import</span> glob
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor
<span class="token keyword">import</span> torch <span class="token keyword">as</span> t

<span class="token comment" spellcheck="true"># å®šä¹‰model</span>
config_file <span class="token operator">=</span> <span class="token string">"/home/lry/projects/mmdetection/configs/fenghuo/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo.py"</span>
checkpoint_file_before <span class="token operator">=</span> <span class="token string">"/home/lry/projects/mmdetection/work_dirs/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_fenghuo/latest.pth"</span>
checkpoint_file_after <span class="token operator">=</span> <span class="token string">"/home/lry/checkpoints/fenghuo/model_segementation_maskrcnn_10/latest.pth"</span>
model_before <span class="token operator">=</span> init_detector<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint_file_before<span class="token punctuation">,</span>device<span class="token operator">=</span><span class="token string">"cuda:3"</span><span class="token punctuation">)</span>
model_after <span class="token operator">=</span> init_detector<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint_file_after<span class="token punctuation">,</span>device<span class="token operator">=</span><span class="token string">"cuda:2"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># é€‰å–éªŒè¯é›†çš„å‰10å¼ å›¾ç‰‡è¿›è¡ŒéªŒè¯</span>
imgs <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'/home/lry/data/780b_std/val/*.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> img <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result_b <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model_before<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    model_before<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>img<span class="token punctuation">,</span> result_b<span class="token punctuation">,</span> out_file<span class="token operator">=</span>f<span class="token string">'/home/lry/checkpoints/fenghuo/compare/before/demo_val{i}.jpg'</span><span class="token punctuation">)</span>

    result_a <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model_after<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    model_after<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>img<span class="token punctuation">,</span> result_a<span class="token punctuation">,</span> out_file<span class="token operator">=</span>f<span class="token string">'/home/lry/checkpoints/fenghuo/compare/after/demo_val{i}.jpg'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="è®­ç»ƒæ³¨æ„"><a href="#è®­ç»ƒæ³¨æ„" class="headerlink" title="è®­ç»ƒæ³¨æ„"></a>è®­ç»ƒæ³¨æ„</h2><p>è¿™é‡Œè®­ç»ƒçš„æ—¶å€™ä¸ç»„é•¿äº¤æµçš„æ—¶å€™å‘ç°æœ‰è¿™ä¹ˆä¸€äº›é—®é¢˜ï¼š</p>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.bmp" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.bmp" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone, qq, weibo, douban"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            
            
            
            <div class="reprint1">
                <p>
                    <span class="reprint1-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;Reprint policy:
                    </span>
                    <a href="https://lry89757.github.io" class="b-link-green">LRY's Blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2021/11/09/mmdet-project-of-fenghuo/" class="b-link-green">mmdet &amp;&amp; project of fenghuo</a>
                </p>
            </div>

        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/11/16/c-bi-ji-yun-suan-fu-chong-zai/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="C++ç¬”è®°è¿ç®—ç¬¦é‡è½½">
                        
                        <span class="card-title">C++ç¬”è®°è¿ç®—ç¬¦é‡è½½</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            æœ€è¿‘äº‹æƒ…ä¸€å¤šèµ·æ¥ï¼Œå‘ç°è‡ªå·±å†™åšå®¢æ²¡æœ‰ä¹‹å‰é‚£ä¹ˆè®¤çœŸäº†ï¼Œå†™å¾—å«é‡‘é‡ä¹Ÿæœ‰æ‰€ä¸‹é™ï¼Œä»¥å¾€ç‚¹å¼€ä¸€çœ‹éƒ½æ˜¯ä¸€äº›è‡ªè®¤ä¸ºéå¸¸æœ‰æŠ€æœ¯å«é‡ã€å†™å¾—éå¸¸ç²¾å½©çš„åšæ–‡ï¼Œä½†æ˜¯ç°åœ¨ç‚¹å¼€ä¸€çœ‹è‡ªå·±æœ€è¿‘å†™çš„åšæ–‡ï¼Œæˆ‘è‡ªå·±éƒ½ä¸æƒ³ç‚¹å¼€å†çœ‹ç¬¬äºŒéæ¯”ä¹‹å‰æ•·è¡äº†å¥½å¤šçœŸæ˜¯ï¼Œæ—¥å¿—æ›´æ˜¯æ—©å°±ä¸æ›´æ–°äº†ï¼Œè¿™äº›éƒ½ä¸æ˜¯ä»€ä¹ˆå¥½ä¹ æƒ¯ã€‚ä»¥åè¦åŠæ—¶æ³¨æ„è‡ªå·±åšæ–‡çš„è´¨é‡ï¼Œåˆ«æ•´çš„è‡ªå·±éƒ½çœ‹ä¸æ‡‚å°±æ›´æ— æ³•æŒ‡æœ›åˆ«äººèƒ½å¤Ÿå­¦åˆ°ä¸œè¥¿äº†ã€‚
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-11-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/C/" class="post-category" target="_blank">
                                    C++
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/" target="_blank">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/11/06/rpc-explore/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="rpc explore">
                        
                        <span class="card-title">rpc explore</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Prefaceæœ€è¿‘åœ¨å­¦C++ï¼Œæƒ³è¦å†™ä¸€äº›C++çš„ä»£ç ï¼Œä½†æ˜¯ç›®å‰è‹¦äºä¸çŸ¥é“å†™å•¥æ¯”è¾ƒå¥½ï¼Œæƒ³å†™ä¸€äº›æ¯”è¾ƒå®ç”¨çš„ï¼Œä½†æ˜¯ç¡®å®æ²¡å•¥èƒ½åŠ›ï¼Œæ‰¾äº†æ‰¾é¡¹ç›®ç»„é•¿jhyï¼Œä»–å‘Šè¯‰æˆ‘è¯´æœ€è¿‘ä»–æœ‰ä¸€äº›å†™è½®å­çš„éœ€æ±‚ï¼Œæ­£å¥½æˆ‘æ‹¿è¿™ä¸ªç»ƒä¸€ä¸‹æ‰‹ã€‚
rpcï¼Œè¿™ä¸ªä¼¼ä¹æ¶‰åŠåˆ°äº†ç½‘ç»œç¼–ç¨‹â€¦â€¦
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-11-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/C/" class="post-category" target="_blank">
                                    C++
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/" target="_blank">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: LRY's Blog<br />'
            + 'Author: é€¯æ¶¦é›¨<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…Lurunyuæ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6, h7'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6, h7').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&copy; 2021 é€¯æ¶¦é›¨. 

            <br>
            <span id="sitetime"></span><span class="my-face">áƒ¦ã‚â—¡â•¹)ãƒâ™¡</span>
            <br>

            

            
                    
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        äººæ¬¡&nbsp; | &nbsp;è®¿å®¢äººæ•°: <span id="busuanzi_value_site_uv" class="white-color"></span> äºº
                    
    
            

            
                &nbsp; | &nbsp;å­—æ•°ç»Ÿè®¡:&nbsp;
                <span class="white-color">213.8k</span> å­—
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/LRY89757" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=lry89757@gmail.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




    <a href="https://zhihu.com/people/yi-ran-fan-te-xi-57-88" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„çŸ¥ä¹" data-position="top" data-delay="50">
        <i class="fa fa-inverse">çŸ¥</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=1785435713&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„QQç©ºé—´" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
        year - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
        month - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
        day - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
        hours - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
        minutes - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
        seconds - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
        microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•° */

        var t1 = Date.UTC(2021, 07, 29, 00, 00, 00); //åŒ—äº¬æ—¶é—´2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²å‹‰å¼ºè¿è¡Œ " + diffYears + " å¹´ " + diffDays + " å¤© " + diffHours +
            " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’" ;
    } /*å› ä¸ºå»ºç«™æ—¶é—´è¿˜æ²¡æœ‰ä¸€å¹´ï¼Œå°±å°†ä¹‹æ³¨é‡Šæ‰äº†ã€‚éœ€è¦çš„å¯ä»¥å–æ¶ˆ*/
    siteTime();
</script>






        <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
        <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="https://cdn.bootcss.com/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://cdn.bootcss.com/masonry/4.2.2/masonry.pkgd.min.js"></script>
        <script src="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.js"></script>
        <script src="https://cdn.bootcss.com/scrollprogress/3.0.2/scrollProgress.min.js"></script>
        <script src="https://cdn.bootcss.com/lightgallery/1.6.12/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        

        
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "çœ‹ä¸è§æˆ‘ğŸ™ˆ~çœ‹ä¸è§æˆ‘ğŸ™ˆ~", clearTimeout(st)) : (document.title =
                    "(à¹‘â€¢Ì€ã…‚â€¢Ì) âœ§è¢«å‘ç°äº†ï½", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- é¼ æ ‡ç‚¹å‡»çƒŸèŠ±çˆ†ç‚¸æ•ˆæœ   -->
        
            <canvas class="fireworks" style="position: fixed; left: 0; top: 0; z-index: 1; pointer-events: none;"></canvas>
            <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
            <script type="text/javascript" src="/js/fireworks.js"></script>
        

        <!-- èƒŒæ™¯é›ªèŠ±é£˜è½ç‰¹æ•ˆ -->
        

        <!-- é¼ æ ‡ç‚¹å‡»æ–‡å­—ç‰¹æ•ˆ -->
        
            <script src="/js/wenzi.js" type="text/javascript"></script>
        

        <!-- èƒŒæ™¯é›ªèŠ±é£˜è½ç‰¹æ•ˆ  -->
        
            <script type="text/javascript">
                var windowWidth = $(window).width();
                if (windowWidth > 768) {
                    document.write('<script type="text/javascript" src="/js/xuehuapiaoluo.js"><\/script>');
                }
            </script>
        

        <!-- åœ¨çº¿èŠå¤©å·¥å…·   -->
        
            <script src="//code.tidio.co/xxxxxxxxxxxxxxxxxxxxxxxxxxx.js"></script>
            <!--  åœ¨çº¿èŠå¤©ä½ç½®è‡ªå®šä¹‰    -->
            <script> 
                $(document).ready(function () {

                    setInterval(change_Tidio, 50);  
                    function change_Tidio() { 

                        var tidio=$("#tidio-chat iframe");
                        if(tidio.css("display")=="block"&& $(window).width()>977 ){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"80px":"20px";   
                            document.getElementById("tidio-chat-iframe").style.right="-15px";   
                            document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        } 
                        else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                            document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        }
                        else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        }

                        if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                            document.getElementById("tidio-chat-iframe").style.zIndex="998";
                        }
                    } 
                }); 
            </script>
        

        <!-- èƒŒæ™¯ canvas-nest  -->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" color="0,0,255" pointColor="0,0,255" opacity= "0.8" zIndex="--1" count="150"src="/libs/background/canvas-nest.js"><\/script>');
            }
            </script>
        

        <!-- èƒŒæ™¯é™æ­¢å½©å¸¦  -->
        

        <!-- èƒŒæ™¯åŠ¨æ€å½©å¸¦ -->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" src="/libs/background/ribbon-dynamic.js"><\/script>');
            }
            </script>
        

    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script><script>!function(e){var r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function t(){for(var c=0;c<r.length;c++)t=r[c],void 0,0<=(n=t.getBoundingClientRect()).top&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=r[c];t=o,n=function(){r=r.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}t(),e.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(t,e)})}(this);</script></body>
</html>